import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // Azure OpenAI configuration
    const azureEndpoint = Deno.env.get('AZURE_OPENAI_ENDPOINT');
    const azureApiKey = Deno.env.get('AZURE_OPENAI_API_KEY');
    const azureDeploymentName = Deno.env.get('AZURE_OPENAI_DEPLOYMENT_NAME');

    if (!azureEndpoint || !azureApiKey || !azureDeploymentName) {
      throw new Error('Azure OpenAI configuration not complete. Required: AZURE_OPENAI_ENDPOINT, AZURE_OPENAI_API_KEY, AZURE_OPENAI_DEPLOYMENT_NAME');
    }

    const { text, fileName } = await req.json();
    
    if (!text || !fileName) {
      throw new Error('Text and fileName are required');
    }

    console.log(`Processing text for ${fileName}: ${text.length} characters`);

    const cleanedText = cleanHebrewText(text);
    const maxLength = 25000;
    const truncatedText = cleanedText.length > maxLength ? cleanedText.substring(0, maxLength) + '...' : cleanedText;
    
    const readableRatio = calculateReadableRatio(truncatedText);
    console.log(`Text readability ratio: ${readableRatio}%`);
    
    if (readableRatio < 30) {
      throw new Error('×”×˜×§×¡×˜ ×©× ×—×œ×¥ ××”×§×•×‘×¥ ××™× ×• ×§×¨×™× ××¡×¤×™×§');
    }
    
    const prompt = createEnhancedExtractionPrompt(truncatedText);
    
    // Azure OpenAI API URL
    const azureUrl = `${azureEndpoint}/openai/deployments/${azureDeploymentName}/chat/completions?api-version=2024-02-15-preview`;
    
    console.log(`Calling Azure OpenAI at: ${azureEndpoint}`);
    
    const response = await fetch(azureUrl, {
      method: 'POST',
      headers: {
        'api-key': azureApiKey,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        messages: [
          { 
            role: "system", 
            content: "Extract ALL information from Hebrew medical committee documents. Pay special attention to extract EVERY row from the '×§×‘×™×¢×ª ××—×•×–×™× ×¨×¤×•××™×™×' table - typically 10-15 rows. Do not stop early!"
          },
          { role: "user", content: prompt }
        ],
        temperature: 0,
        max_tokens: 16000,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Azure OpenAI API error:', response.status, errorText);
      throw new Error(`Azure OpenAI API error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    const content = data.choices[0].message.content;
    
    if (!content) {
      throw new Error('Azure OpenAI returned empty response');
    }

    console.log('Azure OpenAI raw response content:', content);

    const result = parseOpenAIResponse(content);
    
    console.log('Processed result:', result);
    
    return new Response(JSON.stringify(result), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });

  } catch (error) {
    console.error('Error in process-text function:', error);
    return new Response(JSON.stringify({ 
      error: error instanceof Error ? error.message : 'Unknown error'
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  }
});

function createEnhancedExtractionPrompt(text: string): string {
  return `××ª×” ××•××—×” ×‘×—×™×œ×•×¥ ××™×“×¢ ×××¡××›×™ ×•×¢×“×•×ª ×¨×¤×•××™×•×ª ×©×œ ×‘×™×˜×•×— ×œ××•××™ ×•××¡ ×”×›× ×¡×” ×‘×¢×‘×¨×™×ª.

**âš ï¸ ×—×•×‘×” ×œ×§×¨×•×! ×›×œ×œ×™× ×§×¨×™×˜×™×™× ×œ××—×•×–×™ × ×›×•×ª ×•×ª××¨×™×›×™×:**

**×›×œ×œ 1: ××—×•×–×™ × ×›×•×ª**
×× ××ª×” ×¨×•××” ×‘××¡××š ××©×¤×˜ ×›××•:
"×- XX/XX/XXXX ×•××™×œ×š × ×§×‘×¢×” ×œ×š × ×›×•×ª ×§×‘×•×¢×” ×©×œ XX.XX%"
"× ×§×‘×¢×” ×œ×š × ×›×•×ª ×¦××™×ª×” ×©×œ XX%"
"× ×§×‘×¢×” ×œ×š × ×›×•×ª ×–×× ×™×ª ×©×œ XX%"

â†’ **×–×”×• ×”××—×•×– ×”×××™×ª×™ ×•×”×¡×•×¤×™! ×”×©×ª××© ×¨×§ ×‘×•!**
â†’ **×”×ª×¢×œ× ××›×œ ×˜×‘×œ×” ××—×¨×ª ×¢× ××—×•×–×™ × ×›×•×ª!**
â†’ ××©×¤×˜ ×–×” × ××¦× ×‘×“×¨×š ×›×œ×œ ×‘×¢××•×“ ×”××—×¨×•×Ÿ ××• ×œ×¤× ×™ ×”××—×¨×•×Ÿ.

**×›×œ×œ 2: ×ª××¨×™×›×™× (××ª××¨×™×š / ×¢×“ ×ª××¨×™×š / ××™×“×ª ×”× ×›×•×ª)**
â†’ **×—×¤×© ×˜×‘×œ×” ×¢× "× ×›×•×ª ××©×•×§×œ×œ" ××• "×©×§×œ×•×œ × ×›×•×ª"**
â†’ **×–×•×”×™ ×”×˜×‘×œ×” ×”×¡×•×¤×™×ª! ×§×— ××ª ×”×ª××¨×™×›×™× ×¨×§ ××©×!**
â†’ **×”×ª×¢×œ× ××ª××¨×™×›×™× ×‘×˜×‘×œ××•×ª ×©×œ ×œ×™×§×•×™×™× ×¡×¤×¦×™×¤×™×™×!**
â†’ ×‘×˜×‘×œ×” ×–×• ×ª××¦× ××ª "××ª××¨×™×š" ×•"×¢×“ ×ª××¨×™×š" ×”× ×›×•× ×™×
â†’ ×©×™× ×œ×‘: ×× ×›×ª×•×‘ "×–×× ×™" â†’ ××™×“×ª ×”× ×›×•×ª ×”×™× "×–×× ×™"
â†’ ×©×™× ×œ×‘: ×× ×›×ª×•×‘ "×¦××™×ª" â†’ ××™×“×ª ×”× ×›×•×ª ×”×™× "×¦××™×ª"

**×›×œ×œ×™× ×§×¨×™×˜×™×™×:**
1. ×—×¤×© ×‘×›×œ ×”×¢××•×“×™× - ×‘××™×•×—×“ ×”×¢××•×“×™× ×”××—×¨×•× ×™×!
2. ×›×œ ×©×“×” ×—×™×™×‘ ×œ×”×ª×‘×¡×¡ ×¢×œ ××™×“×¢ ××“×•×™×§ ××”××¡××š - ×œ× ×œ×”××¦×™× ×›×œ×•×!
3. ×× ×”××™×“×¢ ×œ× × ××¦× ×‘××¡××š - ×”×—×–×¨ null ×‘××§×•× ×œ× ×—×©
4. ×©×™× ×œ×‘ ×œ××™×“×¢ ×‘×›×•×ª×¨×•×ª ×•×‘×ª×—×™×œ×ª ×”××¡××š
5. **×”×‘×“×œ ×‘×™×Ÿ ××‘×—× ×” ×œ×¡×¢×™×£ ×œ×™×§×•×™** - ××œ×• ×©× ×™ ×©×“×•×ª × ×¤×¨×“×™×!

**×˜×§×¡×˜ ×”××¡××š:**
${text}

**××©×™××”:** ×—×œ×¥ ××™×“×¢ ××›×œ ×”×¢××•×“×™×:

**1. ×›×•×ª×¨×ª ×”×•×¢×“×”:**
- ×—×¤×© ××ª ×”×›×•×ª×¨×ª ×”××œ××” ×©×œ ×”×•×¢×“×” ×‘×¨××© ×”××¡××š
- ×“×•×’×××•×ª: "×“×•×— ×—×•×•×ª ×“×¢×ª ×›×™×¨×•×¨×’×™×” ××•×¨×•×œ×•×’×™×ª ×œ×¤×™ ×¤×§×•×“×ª ××¡ ×”×›× ×¡×”", "×“×•×— × ×›×•×ª ×¨×¤×•××™×ª", "×¤×˜×•×¨ ×××¡ ×”×›× ×¡×”"
- **×–×” ×¦×¨×™×š ×œ×”×™×•×ª ×”×›×•×ª×¨×ª ×”××“×•×™×§×ª ×©×‘×¨××© ×”××¡××š**

**2. ×¤×¨×˜×™ ×”××‘×•×˜×— - ×—×¤×© ×‘×›×œ ×”××§×•××•×ª ×”×‘××™×:**
- **×©× ×”××‘×•×˜×—**: 
  â€¢ ×‘×›×•×ª×¨×ª ×”×¢×œ×™×•× ×” (×›××• "×œ×™××•×¨ ×§×¦×¤", "×§×™×‘×•×‘×™×¥ ××™×§×”")
  â€¢ ×‘×©×•×¨×” "×–×”×•×ª, ××¡×¤×¨: XXXXXXXX ×©× ×©×" - ×”×©× ××•×¤×™×¢ ××—×¨×™ ×”××¡×¤×¨!
  â€¢ ×‘×˜×‘×œ×ª "×¤×¨×˜×™× ××™×©×™×™×" ×ª×—×ª "×©×:" ××• "×–×”×•×ª: ××¡×¤×¨"
  â€¢ **×©×™× ×œ×‘!** ×œ×¤×¢××™× ×”×©× ×•×”×ª.×– ××•×¤×™×¢×™× ×‘××•×ª×” ×©×•×¨×” - ×”×©× ×‘× ××—×¨×™ ×”××¡×¤×¨
  
- **×ª.×–:**: 
  â€¢ **×—×•×‘×” ×œ××¦×•×! ×—×¤×© ×‘×›×œ ×”××§×•××•×ª ×”×‘××™×:**
    1. **×‘×˜×‘×œ×ª "×¤×¨×˜×™× ××™×©×™×™×"** - ×©×•×¨×” "××¡×¤×¨ ×–×”×•×ª:" ××• "×–×”×•×ª:"
    2. ×‘×›×•×ª×¨×ª ×”×¢×œ×™×•× ×” - "×–×”×•×ª, ××¡×¤×¨: XXXXXXXX"
    3. ×‘×©×•×¨×” ×”×¨××©×•× ×” ×©×œ ×”×˜×‘×œ×” - ×œ×¤×¢××™× ×›×ª×•×‘ "×–×”×•×ª: ××¡×¤×¨: XXXXXXXX ×©× ×¤×¨×˜×™ ×©× ××©×¤×—×”"
    4. ×—×¤×© ×‘×›×œ ×”×¢××•×“ ×”×¨××©×•×Ÿ ××¡×¤×¨ ×©×œ 8-9 ×¡×¤×¨×•×ª
  â€¢ **×–×” ×ª××™×“ ××¡×¤×¨ ×©×œ 8-9 ×¡×¤×¨×•×ª ×‘×œ×‘×“**
  â€¢ ×“×•×’×××•×ª × ×›×•× ×•×ª: "29393154", "11327061", "123456789"
  â€¢ **×œ× ×œ×§×—×ª:** ××¡×¤×¨ ×•×¢×“×” (NV-XXXXX), ××¡×¤×¨ ×ª×™×§, ×˜×œ×¤×•×Ÿ, ×ª××¨×™×š

**3. ×ª××¨×™×›×™× ×—×©×•×‘×™×:**
- **×ª××¨×™×š ×•×¢×“×”**: 
  â€¢ **×—×•×‘×” ×œ××¦×•×! ×—×¤×© ×‘×›×œ ×”××§×•××•×ª ×”×‘××™×:**
    1. **×‘×˜×‘×œ×ª "×¤×¨×˜×™× ××™×©×™×™×"** - ×©×•×¨×” "×ª××¨×™×š ×”×•×¢×“×”:" ××• "×ª××¨×™×š ×•×¢×“×”:"
    2. ×‘×›×•×ª×¨×ª ××• ×‘×ª×—×™×œ×ª ×”××¡××š - "×ª××¨×™×š: DD/MM/YYYY"
    3. ×œ×¤× ×™ ×˜×‘×œ×ª "××©×ª×ª×¤×™ ×”×•×¢×“×”" - ×œ×¤×¢××™× ×›×ª×•×‘ "×ª××¨×™×š:"
    4. ×—×¤×© ×ª××¨×™×š ×‘×¤×•×¨××˜ DD/MM/YYYY ×‘×¢××•×“ ×”×¨××©×•×Ÿ
  â€¢ ×“×•×’××”: "29/09/2025"
  â€¢ ×–×” ×”×ª××¨×™×š ×©×‘×• ×”×ª×§×™×™××” ×”×•×¢×“×”
  â€¢ **×œ× ×œ×‘×œ×‘×œ** ×¢× ×ª××¨×™×š ×œ×™×“×” ××• ×ª××¨×™×š ×¤×’×™×¢×”!
  
- **×ª××¨×™×š ×¤×’×™×¢×”**: 
  â€¢ **×—×¤×© ×‘×˜×‘×œ×” "×¤×¨×˜×™ ×”×¤×’×™×¢×”"** ×ª×—×ª "×ª××¨×™×š ×”×¤×’×™×¢×”:"
  â€¢ **××•** ×—×¤×© ×‘×›×œ ××§×•× ×‘××¡××š "×ª××¨×™×š ×”××™×¨×•×¢:" ××• "×ª××¨×™×š ×¤×’×™×¢×”:"
  â€¢ ×“×•×’××”: "01/01/2020"
  â€¢ **×¨×œ×•×•× ×˜×™ ×¨×§ ×œ××™×‘×” ×•× ×›×•×ª ××¢×‘×•×“×”** - ×”×—×–×¨ null ×× ×œ× ×§×™×™×

**4. ××©×ª×ª×¤×™ ×”×•×¢×“×” - ×—×©×•×‘ ×××•×“!:**

**âš ï¸ ×›×œ×œ×™× ×§×¨×™×˜×™×™× ×œ××©×ª×ª×¤×™ ×•×¢×“×”:**
- ×—×¤×© ×‘×§×˜×¢ **"××©×ª×ª×¤×™ ×”×•×¢×“×”"** ××• **"×—×‘×¨×™ ×”×•×¢×“×”"**
- **××œ ×ª×›×œ×•×œ ××–×›×™×¨!** - ×¨×§ ×¨×•×¤××™× ×•××•××—×™×
- ×›×œ ××©×ª×ª×£ ××•×¤×™×¢ ×‘×©×•×¨×” × ×¤×¨×“×ª ×¢× ×©× ×•×ª×¤×§×™×“
- **×¤×•×¨××˜×™× ××¤×©×¨×™×™×:**
  â€¢ "×“"×¨ ××™×›××œ ×‘×œ×•×× ×˜×œ - ×›×™×¨×•×¨×’×™×” ××•×¨×•×œ×•×’×™×ª"
  â€¢ "×“"×¨ ×™×¢×§×‘ ××¨×“ ×¨×¤×•××” ×“×—×•×¤×”,×¨×¤×•××” ×¤× ×™××™×ª"
  â€¢ "××•×¨×•×œ×•×’×™×ª ×›×™×¨×•×¨×’×™×” ×‘×œ×•×× ×˜×œ ××™×›××œ ×“"×¨" (×¡×“×¨ ×”×¤×•×š!)

**ğŸ“‹ ×“×•×’××” ××”××¡××š:**
[××©×ª×ª×¤×™ ×”×•×¢×“×”]
[×©×: ×“"×¨ ×™×¢×§×‘ ××¨×“, ×ª×¤×§×™×“: ×¨×¤×•××” ×“×—×•×¤×”,×¨×¤×•××” ×¤× ×™××™×ª]
[×©×: ××•×¨×˜×œ ×¤×œ×“, ×ª×¤×§×™×“: ××–×›×™×¨ ×”×™×©×™×‘×”]

**â†’ ×”×—×–×¨:**
- "××©×ª×ª×£ ×•×¢×“×” 1": "×“"×¨ ×™×¢×§×‘ ××¨×“ (×¨×¤×•××” ×“×—×•×¤×”, ×¨×¤×•××” ×¤× ×™××™×ª)"
- "××©×ª×ª×£ ×•×¢×“×” 2": null  â† ×›×™ ×™×© ×¨×§ ×¨×•×¤× 1
- "××©×ª×ª×£ ×•×¢×“×” 3": null
- "××©×ª×ª×£ ×•×¢×“×” 4": null

**×—×•×‘×”:**
- **×œ× ×œ×›×œ×•×œ** "××–×›×™×¨ ×”×™×©×™×‘×”", "××–×›×™×¨ ×™×©×™×‘×”", "××–×›×™×¨×•×ª"
- ×× ××™×Ÿ ××©×ª×ª×¤×™× â†’ ×”×—×–×¨ null ×œ×›×œ 4 ×”×©×“×•×ª
- ×¤×•×¨××˜: "×©× ××œ× (×ª×¤×§×™×“)"

**5. ×¡×•×’ ×”×•×•×¢×“×” ×•×”×˜×•×¤×¡:**
- **×¡×•×’ ×•×¢×“×”**: ×—×¤×© "×•×¢×“×ª ××©×›×•×œ × ×¤×’×¢×™ ×¢×‘×•×“×”" ××• "×•×¢×“×” ×¨×¤×•××™×ª" ××• "×•×¢×“×ª ×¤×˜×•×¨ ×××¡"
- **×©× ×˜×•×¤×¡**: ×§×‘×¢ ×œ×¤×™ ×ª×•×›×Ÿ:
  â€¢ ×× ×™×© "×¤×˜×•×¨ ×××¡" ××• "××¡ ×”×›× ×¡×”" ××• "×¤×§×•×“×ª ××¡ ×”×›× ×¡×”" ×‘×›×•×ª×¨×ª = "×¤×˜×•×¨ ×××¡"
  â€¢ ×× ×™×© "××™×‘×”" ×‘×›×•×ª×¨×ª = "××™×‘×”"
  â€¢ ×× ×™×© "×ª××¨×™×š ×¤×’×™×¢×”" + "××¢×‘×•×“×”" = "× ×›×•×ª ××¢×‘×•×“×”"
  â€¢ ×× ××™×Ÿ ×ª××¨×™×š ×¤×’×™×¢×” = "× ×›×•×ª ×›×œ×œ×™×ª"
- **×¡× ×™×£ ×”×•×•×¢×“×”**: ×›××• "×¡× ×™×£ ×¨××©×™ ×¨××ª ×’×Ÿ", "×¡× ×™×£ ×¨××©×™ × ×ª× ×™×”"

**6. ×˜×‘×œ×ª ×”×—×œ×˜×•×ª - ×—×œ×¥ ××ª ×›×œ ×”×©×•×¨×•×ª ××”×˜×‘×œ×” "×§×‘×™×¢×ª ××—×•×–×™× ×¨×¤×•××™×™×":**

**âš ï¸ ×”×‘× ×ª ××‘× ×” ×”×˜×‘×œ×”:**

×”×˜×‘×œ×” × ×¨××™×ª ×›×š:
[×§×‘×™×¢×ª ××—×•×–×™× ×¨×¤×•××™×™×]

×ª×§×•×¤×”: ×: 21/08/2018 ×¢×“: 31/12/2020 | ××‘×—× ×”: ×ª×¡××•× ×ª ×§×¨×¤×œ×™×ª ×“×• ×¦×“×“×™ | ×¡×¢×™×£: 31(4)(×) | ××—×•×–: 10% 10% | ×”×¢×¨×•×ª: ×–×× ×™
×ª×§×•×¤×”: ×: 25/05/2020 | ××‘×—× ×”: ×›××‘ ×‘××¤×¨×§ ×”×›×ª×£ ×™××™×Ÿ | ×¡×¢×™×£: 42(1)(×“)(I) | ××—×•×–: 5% 5% | ×”×¢×¨×•×ª: ×¦××™×ª
×ª×§×•×¤×”: ×: 01/01/2021 | ××‘×—× ×”: ×ª×¡××•× ×ª ×§×¨×¤×œ×™×ª ×©×××œ | ×¡×¢×™×£: 31(4)(×) | ××—×•×–: 5% 5% | ×”×¢×¨×•×ª: ×¦××™×ª

**×©×™× ×œ×‘:**
- ×¢××•×“×” "×ª×§×•×¤×”" ×™×›×•×œ×” ×œ×”×›×™×œ:
  â€¢ "×: DD/MM/YYYY ×¢×“: DD/MM/YYYY" â†’ ×™×© ×ª××¨×™×š ×”×ª×—×œ×” ×•×¡×™×•×
  â€¢ "×: DD/MM/YYYY" â†’ ×™×© ×¨×§ ×ª××¨×™×š ×”×ª×—×œ×” (×¡×™×•× = "×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”")
- ×¢××•×“×” "×¡×¢×™×£ ×œ×™×§×•×™" ××›×™×œ×” ×§×•×“ ××œ× ×›××•: "31(4)(×)", "42(1)(×“)(I)", "(II)(3)73"
- ×¢××•×“×” "××—×•×– ×”× ×›×•×ª" ×œ×¤×¢××™× ××•×¤×™×¢×” ×¤×¢××™×™× (10% 10%) - **×§×— ××ª ×”××¡×¤×¨ ×”×¨××©×•×Ÿ**
- ×¢××•×“×” "×”×¢×¨×•×ª" ××›×™×œ×” "×–×× ×™" ××• "×¦××™×ª" - ×–×• "××™×“×ª ×”× ×›×•×ª"

**âš ï¸ ×§×¨×™×˜×™ ×××•×“! ×”×‘× ×ª ×”×¢××•×“×•×ª - ×‘×“×•×§ 3 ×¤×¢××™×!**

**ğŸ”´ ×›×œ×œ ××¡×¤×¨ 1 - ×—×¤×© ××ª ×”×˜×‘×œ×” ×”× ×›×•× ×”!**
- ×”×˜×‘×œ×” × ×§×¨××ª **"×§×‘×™×¢×ª ××—×•×–×™× ×¨×¤×•××™×™×"** - ×—×¤×© ×‘×“×™×•×§ ××ª ×”×›×•×ª×¨×ª ×”×–×•!
- ××œ ×ª×ª×‘×œ×‘×œ ×¢× ×˜×‘×œ××•×ª ××—×¨×•×ª ×‘××¡××š ×©××›×™×œ×•×ª ×—×•×•×ª ×“×¢×ª ×‘×•×“×“×•×ª
- ×–×• ×”×˜×‘×œ×” ×”××¨×›×–×ª ×•×”×¡×•×¤×™×ª ×©××›×™×œ×” ××ª ×›×œ ×”×”×—×œ×˜×•×ª ×‘××§×•× ××—×“

**ğŸ”´ ×›×œ×œ ××¡×¤×¨ 2 - ×ª××¨×™×›×™× ×©×•× ×™× ×œ×›×œ ×©×•×¨×”!**
- **×›×œ ×©×•×¨×” ×‘×˜×‘×œ×” ×™×›×•×œ×” ×œ×”×™×•×ª ××ª×§×•×¤×” ××—×¨×ª ×œ×—×œ×•×˜×™×Ÿ!**
- ×“×•×’×××•×ª:
  â€¢ ×©×•×¨×” 1: ×: 21/08/2018 ×¢×“: 31/12/2020
  â€¢ ×©×•×¨×” 2: ×: 25/05/2020
  â€¢ ×©×•×¨×” 3: ×: 01/01/2021
  â€¢ ×©×•×¨×” 4: ×: 21/01/2021
- **××œ ×ª× ×™×— ×©×›×œ ×”×©×•×¨×•×ª ×××•×ª×” ×ª×§×•×¤×”!**

**ğŸ”´ ×›×œ×œ ××¡×¤×¨ 3 - ××—×•×– ×”× ×›×•×ª ×”×•× ×ª××™×“ ××¡×¤×¨!**
- ×”×©×“×” "××—×•×– ×”× ×›×•×ª" **×—×™×™×‘** ×œ×”×›×™×œ ××¡×¤×¨: 5%, 10%, 15%, 20%, 25%, 30%, ×•×›×•'
- **×–×” ××£ ×¤×¢× ×œ× ×™×›×•×œ ×œ×”×™×•×ª** "×–×× ×™" ××• "×¦××™×ª" ××• "×§×‘×•×¢"!
- ×× ××ª×” ×¨×•××” "×–×× ×™" ××• "×¦××™×ª" - ×–×” **×œ×** ××—×•×– ×”× ×›×•×ª! ×–×” "××™×“×ª ×”× ×›×•×ª"!

**××™×š ×œ×§×¨×•× ×›×œ ×©×•×¨×” ×‘×˜×‘×œ×” "×§×‘×™×¢×ª ××—×•×–×™× ×¨×¤×•××™×™×":**

×“×•×’××” ×œ×©×•×¨×” ××”×˜×‘×œ×”:
[×: 21/08/2018 ×¢×“: 31/12/2020 | ×ª×¡××•× ×ª ×”×ª×¢×œ×” ×”×§×¨×¤×œ×™×ª ×“×• ×¦×“×“×™ | 31(4)(×) ×¤×’×™×¢×” ×‘×¢×¦×‘... | 10% 10% | ×–×× ×™ - ×¡×¢×™×£ ××•×ª××]

×—×™×œ×•×¥ × ×›×•×Ÿ:
1. **×ª×§×•×¤×”**: "×: 21/08/2018 ×¢×“: 31/12/2020"
   - "××ª××¨×™×š": "21/08/2018"
   - "×¢×“ ×ª××¨×™×š": "31/12/2020"

2. **××‘×—× ×”**: "×ª×¡××•× ×ª ×”×ª×¢×œ×” ×”×§×¨×¤×œ×™×ª ×“×• ×¦×“×“×™"

3. **×¡×¢×™×£ ×œ×™×§×•×™**: "31(4)(×)" â† ×§×— ×¨×§ ××ª ×”×§×•×“, ×œ× ××ª ×”×ª×™××•×¨ ×”××œ×!
   - ×“×•×’×××•×ª ×§×•×“×™×: "31(4)(×)", "42(1)(×“)(I)", "(II)(3)73", "23(2)(×)(II)"

4. **××—×•×– ×”× ×›×•×ª**: "10%" â† ×œ×¤×¢××™× ×›×ª×•×‘ "10% 10%" - ×§×— ××ª ×”××¡×¤×¨ ×”×¨××©×•×Ÿ!

5. **××™×“×ª ×”× ×›×•×ª**: "×–×× ×™" â† ×–×” ××•×¤×™×¢ ×‘×¢××•×“×ª "×”×¢×¨×•×ª"

**âš ï¸ ×§×¨×™×˜×™! ×–×›×•×¨:**
- **×—×œ×¥ ×›×œ ×”×©×•×¨×•×ª!** ×œ× ×¨×§ 2-3! ×× ×™×© 14 ×©×•×¨×•×ª â†’ ×”×—×–×¨ 14 ×”×—×œ×˜×•×ª!
- **××—×•×– ×”× ×›×•×ª** = ××¡×¤×¨ ×‘×œ×‘×“ (5%, 10%, 20%, 30%)
- **××™×“×ª ×”× ×›×•×ª** = ×–×× ×™/×¦××™×ª ×‘×œ×‘×“
- **×¡×¢×™×£ ×œ×™×§×•×™** = ×”×§×•×“ ×”××œ× ××”×˜×‘×œ×”
- **×ª××¨×™×›×™×** = ×›×œ ×©×•×¨×” ×™×›×•×œ×” ×œ×”×™×•×ª ××ª××¨×™×š ××—×¨!
- ×× ×”×˜×‘×œ×” ××¨×•×›×” â†’ **×”××©×š ×¢×“ ×”×¡×•×£, ××œ ×ª×§×¦×¨!**
  
- **××—×•×– ×”× ×›×•×ª ××©×•×§×œ×œ**: ×”×©×§×œ×•×œ ×œ×—×™×©×•×‘ ×¤×˜×•×¨ ×××¡
  â€¢ **×§×¨×™×˜×™! ×¡×“×¨ ×—×™×¤×•×© (×—×•×‘×” ×œ×¢×§×•×‘ ××—×¨×™ ×”×¡×“×¨!):**
    1. **××©×¤×˜ ×¡×™×›×•× ×¡×•×¤×™ - ×–×• ×”×¢×“×™×¤×•×ª ×”××•×—×œ×˜×ª ×”×’×‘×•×”×” ×‘×™×•×ª×¨!**
       - **×ª××™×“** ×—×¤×© ×‘××¡××š ××©×¤×˜ ×©××›×™×œ ××ª ×”××™×œ×™×:
         â€¢ "× ×§×‘×¢×” ×œ×š × ×›×•×ª ×§×‘×•×¢×” ×©×œ"
         â€¢ "× ×§×‘×¢×” ×œ×š × ×›×•×ª ×–×× ×™×ª ×©×œ"
         â€¢ "× ×§×‘×¢×” ×œ×š × ×›×•×ª ×©×œ"
         â€¢ "×•××™×œ×š × ×§×‘×¢×” ×œ×š × ×›×•×ª"
       - ×“×•×’×××•×ª:
         â€¢ "×- 26/03/2025 ×•××™×œ×š × ×§×‘×¢×” ×œ×š × ×›×•×ª ×§×‘×•×¢×” ×©×œ 84.08%" â†’ **84.08%**
         â€¢ "× ×§×‘×¢×” ×œ×š × ×›×•×ª ×¦××™×ª×” ×©×œ 75.5%" â†’ **75.5%**
       - **×× ××¦××ª ××©×¤×˜ ×›×–×” - ×”×©×ª××© ×¨×§ ×‘×•! ×”×ª×¢×œ× ××›×œ ×˜×‘×œ×” ××—×¨×ª!**
       - **×–×”×• ×”××—×•×– ×”××©×•×§×œ×œ ×”×××™×ª×™ ×•×”×¡×•×¤×™ ×•×”××“×•×™×§ ×‘×™×•×ª×¨ ×‘××¡××š!**
    
    2. **×˜×‘×œ×” ×¢× "×©×§×œ×•×œ × ×›×•×ª"** - ×× ×§×™×™××ª ×˜×‘×œ×” ×¡×•×¤×™×ª ×¢× ×¢××•×“×” ×–×•:
       | × ×›×•×ª | ×©×§×œ×•×œ × ×›×•×ª | × ×›×•×ª ××©×•×§×œ×œ |
       | 30.7% | 31% | ×–×× ×™ |
       â†’ ×”×—×–×¨: "31%"
    
    3. **××—×¨×ª** - ×”×—×–×¨ ××ª ××•×ª×• ×¢×¨×š ×›××• "××—×•×– ×”× ×›×•×ª" (×× ××™×Ÿ ×¢××•×“×” × ×¤×¨×“×ª)
  
  â€¢ **×œ× ×ª××™×“ ×™×© ×©×“×” × ×¤×¨×“**, ×‘××§×¨×™× ×¨×‘×™× ×–×” ×–×”×” ×œ"××—×•×– ×”× ×›×•×ª"
  
- **××ª××¨×™×š ×•×¢×“ ×ª××¨×™×š - ×§×¨×™×˜×™!**
  â€¢ **×¡×“×¨ ×—×™×¤×•×© (×‘×¢×“×™×¤×•×ª ×’×‘×•×”×” ×××•×“!):**
    1. **××©×¤×˜ ×¡×™×›×•× ×¡×•×¤×™** - **×–×• ×”×¢×“×™×¤×•×ª ×”×’×‘×•×”×” ×‘×™×•×ª×¨!**:
       - ×—×¤×© ×‘××¡××š ××©×¤×˜ ×›××•:
         â€¢ "×-XX/XX/XXXX ×•××™×œ×š × ×§×‘×¢×” ×œ×š × ×›×•×ª ×§×‘×•×¢×” ×©×œ X%"
         â€¢ "×-XX/XX/XXXX ×¢×“ XX/XX/XXXX × ×§×‘×¢×” ×œ×š × ×›×•×ª ×©×œ X%"
         â€¢ "×-XX/XX/XXXX × ×§×‘×¢×” ×œ×š × ×›×•×ª ×©×œ X%"
       - ×“×•×’××”: "×- 26/03/2025 ×•××™×œ×š × ×§×‘×¢×” ×œ×š × ×›×•×ª ×§×‘×•×¢×” ×©×œ 84.08%"
       - **××ª××¨×™×š**: "26/03/2025"
       - **×¢×“ ×ª××¨×™×š**: "×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”" (×× ×›×ª×•×‘ "×•××™×œ×š" ××• "×§×‘×•×¢×”")
       - **×¢×“ ×ª××¨×™×š**: ×”×ª××¨×™×š ×”×¡×¤×¦×™×¤×™ (×× ×™×© ×ª××¨×™×š ×¡×™×•× ××¤×•×¨×©)
    
    2. **×˜×‘×œ×ª ×©×§×œ×•×œ × ×›×•×ª**:
       - ×—×¤×© ×˜×‘×œ×” ×¢× ×¢××•×“×” "××ª××¨×™×š" + "×¢×“ ×ª××¨×™×š" + "× ×›×•×ª ××©×•×§×œ×œ"
       - ×§×— ××ª ×”×ª××¨×™×›×™× ××”×©×•×¨×” ×”××—×¨×•× ×”/×”×¡×•×¤×™×ª
    
    3. **××—×¨×ª** - ×”×—×–×¨ null

**×¤×•×¨××˜ ×”×—×–×¨×” - JSON ×‘×œ×‘×“:**
{
  "×›×•×ª×¨×ª ×”×•×¢×“×”": "...",
  "×¡×•×’ ×•×¢×“×”": "...",
  "×©× ×˜×•×¤×¡": "...",
  "×¡× ×™×£ ×”×•×•×¢×“×”": "...",
  "×©× ×”××‘×•×˜×—": "...",
  "×ª.×–:": "...",
  "×ª××¨×™×š ×•×¢×“×”": "...",
  "×ª××¨×™×š ×¤×’×™×¢×”(×¨×§ ×‘××™×‘×”,× ×›×•×ª ××¢×‘×•×“×”)": "...",
  "××©×ª×ª×£ ×•×¢×“×” 1": "...",
  "××©×ª×ª×£ ×•×¢×“×” 2": "...",
  "××©×ª×ª×£ ×•×¢×“×” 3": "...",
  "××©×ª×ª×£ ×•×¢×“×” 4": "...",
  "×”×—×œ×˜×•×ª": [
    {
      "××‘×—× ×”": "...",
      "×¡×¢×™×£ ×œ×™×§×•×™": "...",
      "××—×•×– ×”× ×›×•×ª": "...",
      "××ª××¨×™×š": "...",
      "×¢×“ ×ª××¨×™×š": "...",
      "××™×“×ª ×”× ×›×•×ª": "...",
      "×”×¢×¨×•×ª": "..."
    }
  ],
  "××—×•×– ×”× ×›×•×ª ×”× ×•×‘×¢ ××”×¤×’×™×¢×”": "...",
  "××—×•×– ×”× ×›×•×ª ××©×•×§×œ×œ": "...",
  "×©×§×œ×•×œ ×œ×¤×˜×•×¨ ×××¡": "..."
}

**×—×•×‘×”: ×¨×§ JSON, ×œ×œ× ×”×¡×‘×¨×™× ××• ×˜×§×¡×˜ × ×•×¡×£!**`;
}

function cleanHebrewText(text: string): string {
  if (!text) return '';
  
  let cleaned = text
    .replace(/[\u0591-\u05BD\u05BF-\u05C2\u05C4-\u05C5\u05C7]/g, '')
    .replace(/[×ƒÖ¾]/g, ' ')
    .replace(/[\u05D0-\u05EA][\u0590-\u05C7]+/g, match => match.charAt(0))
    .replace(/[×´×³]/g, '"')
    .replace(/\s+/g, ' ')
    .trim();
  
  return cleaned;
}

function calculateReadableRatio(text: string): number {
  if (!text || text.length === 0) return 0;
  
  const hebrewLetters = (text.match(/[\u05D0-\u05EA]/g) || []).length;
  const englishLetters = (text.match(/[A-Za-z]/g) || []).length;
  const digits = (text.match(/\d/g) || []).length;
  const punctuation = (text.match(/[.,;:!?()\-\s]/g) || []).length;
  
  const totalReadable = hebrewLetters + englishLetters + digits + punctuation;
  const ratio = (totalReadable / text.length) * 100;
  
  const hebrewWords = (text.match(/[\u05D0-\u05EA]{2,}/g) || []).length;
  const wordBonus = Math.min(hebrewWords * 2, 20);
  
  return Math.min(ratio + wordBonus, 100);
}

function parseOpenAIResponse(content: string): any {
  console.log('Parsing Azure OpenAI response...');
  
  try {
    let cleanContent = content;
    if (cleanContent.startsWith('```json')) {
      cleanContent = cleanContent.replace(/^```json\s*/, '').replace(/\s*```$/, '');
    } else if (cleanContent.startsWith('```')) {
      cleanContent = cleanContent.replace(/^```\s*/, '').replace(/\s*```$/, '');
    }
    
    cleanContent = fixJsonFormatting(cleanContent);
    
    let extractedData;
    try {
      extractedData = JSON.parse(cleanContent);
    } catch (parseError) {
      const fixedContent = cleanContent
        .replace(/\u200B/g, '')
        .replace(/\u00A0/g, ' ')
        .replace(/[\u200C\u200D]/g, '')
        .trim();
      extractedData = JSON.parse(fixedContent);
    }
    
    console.log('Successfully parsed JSON:', Object.keys(extractedData));
    return extractedData;
    
  } catch (parseError) {
    console.error('JSON parse error:', parseError);
    console.error('Failed content:', content);
    
    // Fallback to regex extraction
    const result: any = {};
    
    const extractField = (pattern: string, fieldName: string) => {
      const match = content.match(new RegExp(`"${pattern}":\\s*"([^"]+)"`, 'i'));
      if (match) {
        result[fieldName] = match[1];
      }
    };
    
    extractField('×›×•×ª×¨×ª ×”×•×¢×“×”', '×›×•×ª×¨×ª ×”×•×¢×“×”');
    extractField('×¡×•×’ ×•×¢×“×”', '×¡×•×’ ×•×¢×“×”');
    extractField('×©× ×˜×•×¤×¡', '×©× ×˜×•×¤×¡');
    extractField('×¡× ×™×£ ×”×•×•×¢×“×”', '×¡× ×™×£ ×”×•×•×¢×“×”');
    extractField('×©× ×”××‘×•×˜×—', '×©× ×”××‘×•×˜×—');
    extractField('×ª\\.×–:', '×ª.×–:');
    extractField('×ª××¨×™×š ×•×¢×“×”', '×ª××¨×™×š ×•×¢×“×”');
    extractField('×ª××¨×™×š ×¤×’×™×¢×”\\(×¨×§ ×‘××™×‘×”,× ×›×•×ª ××¢×‘×•×“×”\\)', '×ª××¨×™×š ×¤×’×™×¢×”(×¨×§ ×‘××™×‘×”,× ×›×•×ª ××¢×‘×•×“×”)');
    extractField('××©×ª×ª×£ ×•×¢×“×” 1', '××©×ª×ª×£ ×•×¢×“×” 1');
    extractField('××©×ª×ª×£ ×•×¢×“×” 2', '××©×ª×ª×£ ×•×¢×“×” 2');
    extractField('××©×ª×ª×£ ×•×¢×“×” 3', '××©×ª×ª×£ ×•×¢×“×” 3');
    extractField('××©×ª×ª×£ ×•×¢×“×” 4', '××©×ª×ª×£ ×•×¢×“×” 4');
    extractField('××—×•×– ×”× ×›×•×ª ×”× ×•×‘×¢ ××”×¤×’×™×¢×”', '××—×•×– ×”× ×›×•×ª ×”× ×•×‘×¢ ××”×¤×’×™×¢×”');
    extractField('××—×•×– ×”× ×›×•×ª ××©×•×§×œ×œ', '××—×•×– ×”× ×›×•×ª ××©×•×§×œ×œ');
    extractField('×©×§×œ×•×œ ×œ×¤×˜×•×¨ ×××¡', '×©×§×œ×•×œ ×œ×¤×˜×•×¨ ×××¡');
    
    console.log('Using regex fallback extraction:', result);
    return result;
  }
}

function fixJsonFormatting(content: string): string {
  let fixed = content.trim();
  
  const jsonStart = fixed.indexOf('{');
  const jsonEnd = fixed.lastIndexOf('}') + 1;
  if (jsonStart !== -1 && jsonEnd !== -1) {
    fixed = fixed.substring(jsonStart, jsonEnd);
  }
  
  fixed = fixed.replace(/}\s*\n?\s*{/g, '},\n    {');
  fixed = fixed.replace(/"\s*\n\s*"/g, '",\n  "');
  fixed = fixed.replace(/"\s*\n\s*}/g, '"\n  }');
  fixed = fixed.replace(/]\s*\n\s*"/g, '],\n  "');
  fixed = fixed.replace(/"null"/g, 'null');
  fixed = fixed.replace(/,\s*}/g, '}');
  fixed = fixed.replace(/,\s*]/g, ']');
  
  return fixed;
}
