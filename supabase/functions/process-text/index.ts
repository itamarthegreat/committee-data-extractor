import "https://deno.land/x/xhr@0.1.0/mod.ts";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const openaiApiKey = Deno.env.get('OPENAI_API_KEY');

    if (!openaiApiKey) {
      throw new Error('OPENAI_API_KEY not configured');
    }

    const { text, fileName } = await req.json();
    
    if (!text || !fileName) {
      throw new Error('Text and fileName are required');
    }

    console.log(`Processing text for ${fileName}: ${text.length} characters`);

    const cleanedText = cleanHebrewText(text);
    const maxLength = 25000; // Increased to capture final summary sentence
    const truncatedText = cleanedText.length > maxLength ? cleanedText.substring(0, maxLength) + '...' : cleanedText;
    
    const readableRatio = calculateReadableRatio(truncatedText);
    console.log(`Text readability ratio: ${readableRatio}%`);
    
    if (readableRatio < 30) {
      throw new Error('×”×˜×§×¡×˜ ×©× ×—×œ×¥ ×ž×”×§×•×‘×¥ ××™× ×• ×§×¨×™× ×ž×¡×¤×™×§');
    }
    
    const prompt = createEnhancedExtractionPrompt(truncatedText);
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${openaiApiKey}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { 
            role: "system", 
            content: "You are an expert at extracting information from Hebrew medical committee documents. You MUST extract ALL rows from the table titled '×§×‘×™×¢×ª ××—×•×–×™× ×¨×¤×•××™×™×'. Count the rows first, then extract them all. DO NOT stop after 5 rows - there are usually 10-15 rows. Extract EVERY SINGLE ROW."
          },
          { role: "user", content: prompt }
        ],
        temperature: 0,
        max_tokens: 16000,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('OpenAI API error:', response.status, errorText);
      throw new Error(`OpenAI API error: ${response.status}`);
    }

    const data = await response.json();
    const content = data.choices[0].message.content;
    
    if (!content) {
      throw new Error('OpenAI returned empty response');
    }

    console.log('OpenAI raw response content:', content);

    const result = parseOpenAIResponse(content);
    
    console.log('Processed result:', result);
    
    return new Response(JSON.stringify(result), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });

  } catch (error) {
    console.error('Error in process-text function:', error);
    return new Response(JSON.stringify({ 
      error: error instanceof Error ? error.message : 'Unknown error'
    }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  }
});

function createEnhancedExtractionPrompt(text: string): string {
  return `××ª×” ×ž×•×ž×—×” ×‘×—×™×œ×•×¥ ×ž×™×“×¢ ×ž×ž×¡×ž×›×™ ×•×¢×“×•×ª ×¨×¤×•××™×•×ª ×©×œ ×‘×™×˜×•×— ×œ××•×ž×™ ×•×ž×¡ ×”×›× ×¡×” ×‘×¢×‘×¨×™×ª.

**âš ï¸ ×—×•×‘×” ×œ×§×¨×•×! ×›×œ×œ×™× ×§×¨×™×˜×™×™× ×œ××—×•×–×™ × ×›×•×ª ×•×ª××¨×™×›×™×:**

**×›×œ×œ 1: ××—×•×–×™ × ×›×•×ª**
×× ××ª×” ×¨×•××” ×‘×ž×¡×ž×š ×ž×©×¤×˜ ×›×ž×•:
"×ž- XX/XX/XXXX ×•××™×œ×š × ×§×‘×¢×” ×œ×š × ×›×•×ª ×§×‘×•×¢×” ×©×œ XX.XX%"
"× ×§×‘×¢×” ×œ×š × ×›×•×ª ×¦×ž×™×ª×” ×©×œ XX%"
"× ×§×‘×¢×” ×œ×š × ×›×•×ª ×–×ž× ×™×ª ×©×œ XX%"

â†’ **×–×”×• ×”××—×•×– ×”××ž×™×ª×™ ×•×”×¡×•×¤×™! ×”×©×ª×ž×© ×¨×§ ×‘×•!**
â†’ **×”×ª×¢×œ× ×ž×›×œ ×˜×‘×œ×” ××—×¨×ª ×¢× ××—×•×–×™ × ×›×•×ª!**
â†’ ×ž×©×¤×˜ ×–×” × ×ž×¦× ×‘×“×¨×š ×›×œ×œ ×‘×¢×ž×•×“ ×”××—×¨×•×Ÿ ××• ×œ×¤× ×™ ×”××—×¨×•×Ÿ.

**×›×œ×œ 2: ×ª××¨×™×›×™× (×ž×ª××¨×™×š / ×¢×“ ×ª××¨×™×š / ×ž×™×“×ª ×”× ×›×•×ª)**
â†’ **×—×¤×© ×˜×‘×œ×” ×¢× "× ×›×•×ª ×ž×©×•×§×œ×œ" ××• "×©×§×œ×•×œ × ×›×•×ª"**
â†’ **×–×•×”×™ ×”×˜×‘×œ×” ×”×¡×•×¤×™×ª! ×§×— ××ª ×”×ª××¨×™×›×™× ×¨×§ ×ž×©×!**
â†’ **×”×ª×¢×œ× ×ž×ª××¨×™×›×™× ×‘×˜×‘×œ××•×ª ×©×œ ×œ×™×§×•×™×™× ×¡×¤×¦×™×¤×™×™×!**
â†’ ×‘×˜×‘×œ×” ×–×• ×ª×ž×¦× ××ª "×ž×ª××¨×™×š" ×•"×¢×“ ×ª××¨×™×š" ×”× ×›×•× ×™×
â†’ ×©×™× ×œ×‘: ×× ×›×ª×•×‘ "×–×ž× ×™" â†’ ×ž×™×“×ª ×”× ×›×•×ª ×”×™× "×–×ž× ×™"
â†’ ×©×™× ×œ×‘: ×× ×›×ª×•×‘ "×¦×ž×™×ª" â†’ ×ž×™×“×ª ×”× ×›×•×ª ×”×™× "×¦×ž×™×ª"

**×›×œ×œ×™× ×§×¨×™×˜×™×™×:**
1. ×—×¤×© ×‘×›×œ ×”×¢×ž×•×“×™× - ×‘×ž×™×•×—×“ ×”×¢×ž×•×“×™× ×”××—×¨×•× ×™×!
2. ×›×œ ×©×“×” ×—×™×™×‘ ×œ×”×ª×‘×¡×¡ ×¢×œ ×ž×™×“×¢ ×ž×“×•×™×§ ×ž×”×ž×¡×ž×š - ×œ× ×œ×”×ž×¦×™× ×›×œ×•×!
3. ×× ×”×ž×™×“×¢ ×œ× × ×ž×¦× ×‘×ž×¡×ž×š - ×”×—×–×¨ null ×‘×ž×§×•× ×œ× ×—×©
4. ×©×™× ×œ×‘ ×œ×ž×™×“×¢ ×‘×›×•×ª×¨×•×ª ×•×‘×ª×—×™×œ×ª ×”×ž×¡×ž×š
5. **×”×‘×“×œ ×‘×™×Ÿ ××‘×—× ×” ×œ×¡×¢×™×£ ×œ×™×§×•×™** - ××œ×• ×©× ×™ ×©×“×•×ª × ×¤×¨×“×™×!

**×˜×§×¡×˜ ×”×ž×¡×ž×š:**
${text}

**×ž×©×™×ž×”:** ×—×œ×¥ ×ž×™×“×¢ ×ž×›×œ ×”×¢×ž×•×“×™×:

**1. ×›×•×ª×¨×ª ×”×•×¢×“×”:**
- ×—×¤×© ××ª ×”×›×•×ª×¨×ª ×”×ž×œ××” ×©×œ ×”×•×¢×“×” ×‘×¨××© ×”×ž×¡×ž×š
- ×“×•×’×ž××•×ª: "×“×•×— ×—×•×•×ª ×“×¢×ª ×›×™×¨×•×¨×’×™×” ××•×¨×•×œ×•×’×™×ª ×œ×¤×™ ×¤×§×•×“×ª ×ž×¡ ×”×›× ×¡×”", "×“×•×— × ×›×•×ª ×¨×¤×•××™×ª", "×¤×˜×•×¨ ×ž×ž×¡ ×”×›× ×¡×”"
- **×–×” ×¦×¨×™×š ×œ×”×™×•×ª ×”×›×•×ª×¨×ª ×”×ž×“×•×™×§×ª ×©×‘×¨××© ×”×ž×¡×ž×š**

**2. ×¤×¨×˜×™ ×”×ž×‘×•×˜×— - ×—×¤×© ×‘×›×œ ×”×ž×§×•×ž×•×ª ×”×‘××™×:**
- **×©× ×”×ž×‘×•×˜×—**: 
  â€¢ ×‘×›×•×ª×¨×ª ×”×¢×œ×™×•× ×” (×›×ž×• "×œ×™××•×¨ ×§×¦×¤", "×§×™×‘×•×‘×™×¥ ×ž×™×§×”")
  â€¢ ×‘×©×•×¨×” "×–×”×•×ª, ×ž×¡×¤×¨: XXXXXXXX ×©× ×©×" - ×”×©× ×ž×•×¤×™×¢ ××—×¨×™ ×”×ž×¡×¤×¨!
  â€¢ ×‘×˜×‘×œ×ª "×¤×¨×˜×™× ××™×©×™×™×" ×ª×—×ª "×©×:" ××• "×–×”×•×ª: ×ž×¡×¤×¨"
  â€¢ **×©×™× ×œ×‘!** ×œ×¤×¢×ž×™× ×”×©× ×•×”×ª.×– ×ž×•×¤×™×¢×™× ×‘××•×ª×” ×©×•×¨×” - ×”×©× ×‘× ××—×¨×™ ×”×ž×¡×¤×¨
  
- **×ª.×–:**: 
  â€¢ **×—×•×‘×” ×œ×ž×¦×•×! ×—×¤×© ×‘×›×œ ×”×ž×§×•×ž×•×ª ×”×‘××™×:**
    1. **×‘×˜×‘×œ×ª "×¤×¨×˜×™× ××™×©×™×™×"** - ×©×•×¨×” "×ž×¡×¤×¨ ×–×”×•×ª:" ××• "×–×”×•×ª:"
    2. ×‘×›×•×ª×¨×ª ×”×¢×œ×™×•× ×” - "×–×”×•×ª, ×ž×¡×¤×¨: XXXXXXXX"
    3. ×‘×©×•×¨×” ×”×¨××©×•× ×” ×©×œ ×”×˜×‘×œ×” - ×œ×¤×¢×ž×™× ×›×ª×•×‘ "×–×”×•×ª: ×ž×¡×¤×¨: XXXXXXXX ×©× ×¤×¨×˜×™ ×©× ×ž×©×¤×—×”"
    4. ×—×¤×© ×‘×›×œ ×”×¢×ž×•×“ ×”×¨××©×•×Ÿ ×ž×¡×¤×¨ ×©×œ 8-9 ×¡×¤×¨×•×ª
  â€¢ **×–×” ×ª×ž×™×“ ×ž×¡×¤×¨ ×©×œ 8-9 ×¡×¤×¨×•×ª ×‘×œ×‘×“**
  â€¢ ×“×•×’×ž××•×ª × ×›×•× ×•×ª: "29393154", "11327061", "123456789"
  â€¢ **×œ× ×œ×§×—×ª:** ×ž×¡×¤×¨ ×•×¢×“×” (NV-XXXXX), ×ž×¡×¤×¨ ×ª×™×§, ×˜×œ×¤×•×Ÿ, ×ª××¨×™×š

**3. ×ª××¨×™×›×™× ×—×©×•×‘×™×:**
- **×ª××¨×™×š ×•×¢×“×”**: 
  â€¢ **×—×•×‘×” ×œ×ž×¦×•×! ×—×¤×© ×‘×›×œ ×”×ž×§×•×ž×•×ª ×”×‘××™×:**
    1. **×‘×˜×‘×œ×ª "×¤×¨×˜×™× ××™×©×™×™×"** - ×©×•×¨×” "×ª××¨×™×š ×”×•×¢×“×”:" ××• "×ª××¨×™×š ×•×¢×“×”:"
    2. ×‘×›×•×ª×¨×ª ××• ×‘×ª×—×™×œ×ª ×”×ž×¡×ž×š - "×ª××¨×™×š: DD/MM/YYYY"
    3. ×œ×¤× ×™ ×˜×‘×œ×ª "×ž×©×ª×ª×¤×™ ×”×•×¢×“×”" - ×œ×¤×¢×ž×™× ×›×ª×•×‘ "×ª××¨×™×š:"
    4. ×—×¤×© ×ª××¨×™×š ×‘×¤×•×¨×ž×˜ DD/MM/YYYY ×‘×¢×ž×•×“ ×”×¨××©×•×Ÿ
  â€¢ ×“×•×’×ž×”: "29/09/2025"
  â€¢ ×–×” ×”×ª××¨×™×š ×©×‘×• ×”×ª×§×™×™×ž×” ×”×•×¢×“×”
  â€¢ **×œ× ×œ×‘×œ×‘×œ** ×¢× ×ª××¨×™×š ×œ×™×“×” ××• ×ª××¨×™×š ×¤×’×™×¢×”!
  
- **×ª××¨×™×š ×¤×’×™×¢×”**: 
  â€¢ **×—×¤×© ×‘×˜×‘×œ×” "×¤×¨×˜×™ ×”×¤×’×™×¢×”"** ×ª×—×ª "×ª××¨×™×š ×”×¤×’×™×¢×”:"
  â€¢ **××•** ×—×¤×© ×‘×›×œ ×ž×§×•× ×‘×ž×¡×ž×š "×ª××¨×™×š ×”××™×¨×•×¢:" ××• "×ª××¨×™×š ×¤×’×™×¢×”:"
  â€¢ ×“×•×’×ž×”: "01/01/2020"
  â€¢ **×¨×œ×•×•× ×˜×™ ×¨×§ ×œ××™×‘×” ×•× ×›×•×ª ×ž×¢×‘×•×“×”** - ×”×—×–×¨ null ×× ×œ× ×§×™×™×

**4. ×ž×©×ª×ª×¤×™ ×”×•×¢×“×” - ×—×©×•×‘ ×ž××•×“!:**

**âš ï¸ ×›×œ×œ×™× ×§×¨×™×˜×™×™× ×œ×ž×©×ª×ª×¤×™ ×•×¢×“×”:**
- ×—×¤×© ×‘×§×˜×¢ **"×ž×©×ª×ª×¤×™ ×”×•×¢×“×”"** ××• **"×—×‘×¨×™ ×”×•×¢×“×”"**
- **××œ ×ª×›×œ×•×œ ×ž×–×›×™×¨!** - ×¨×§ ×¨×•×¤××™× ×•×ž×•×ž×—×™×
- ×›×œ ×ž×©×ª×ª×£ ×ž×•×¤×™×¢ ×‘×©×•×¨×” × ×¤×¨×“×ª ×¢× ×©× ×•×ª×¤×§×™×“
- **×¤×•×¨×ž×˜×™× ××¤×©×¨×™×™×:**
  â€¢ "×“"×¨ ×ž×™×›××œ ×‘×œ×•×ž× ×˜×œ - ×›×™×¨×•×¨×’×™×” ××•×¨×•×œ×•×’×™×ª"
  â€¢ "×“"×¨ ×™×¢×§×‘ ××¨×“ ×¨×¤×•××” ×“×—×•×¤×”,×¨×¤×•××” ×¤× ×™×ž×™×ª"
  â€¢ "××•×¨×•×œ×•×’×™×ª ×›×™×¨×•×¨×’×™×” ×‘×œ×•×ž× ×˜×œ ×ž×™×›××œ ×“"×¨" (×¡×“×¨ ×”×¤×•×š!)

**ðŸ“‹ ×“×•×’×ž×” ×ž×”×ž×¡×ž×š:**
[×ž×©×ª×ª×¤×™ ×”×•×¢×“×”]
[×©×: ×“"×¨ ×™×¢×§×‘ ××¨×“, ×ª×¤×§×™×“: ×¨×¤×•××” ×“×—×•×¤×”,×¨×¤×•××” ×¤× ×™×ž×™×ª]
[×©×: ××•×¨×˜×œ ×¤×œ×“, ×ª×¤×§×™×“: ×ž×–×›×™×¨ ×”×™×©×™×‘×”]

**â†’ ×”×—×–×¨:**
- "×ž×©×ª×ª×£ ×•×¢×“×” 1": "×“"×¨ ×™×¢×§×‘ ××¨×“ (×¨×¤×•××” ×“×—×•×¤×”, ×¨×¤×•××” ×¤× ×™×ž×™×ª)"
- "×ž×©×ª×ª×£ ×•×¢×“×” 2": null  â† ×›×™ ×™×© ×¨×§ ×¨×•×¤× 1
- "×ž×©×ª×ª×£ ×•×¢×“×” 3": null
- "×ž×©×ª×ª×£ ×•×¢×“×” 4": null

**×—×•×‘×”:**
- **×œ× ×œ×›×œ×•×œ** "×ž×–×›×™×¨ ×”×™×©×™×‘×”", "×ž×–×›×™×¨ ×™×©×™×‘×”", "×ž×–×›×™×¨×•×ª"
- ×× ××™×Ÿ ×ž×©×ª×ª×¤×™× â†’ ×”×—×–×¨ null ×œ×›×œ 4 ×”×©×“×•×ª
- ×¤×•×¨×ž×˜: "×©× ×ž×œ× (×ª×¤×§×™×“)"

**5. ×¡×•×’ ×”×•×•×¢×“×” ×•×”×˜×•×¤×¡:**
- **×¡×•×’ ×•×¢×“×”**: ×—×¤×© "×•×¢×“×ª ××©×›×•×œ × ×¤×’×¢×™ ×¢×‘×•×“×”" ××• "×•×¢×“×” ×¨×¤×•××™×ª" ××• "×•×¢×“×ª ×¤×˜×•×¨ ×ž×ž×¡"
- **×©× ×˜×•×¤×¡**: ×§×‘×¢ ×œ×¤×™ ×ª×•×›×Ÿ:
  â€¢ ×× ×™×© "×¤×˜×•×¨ ×ž×ž×¡" ××• "×ž×¡ ×”×›× ×¡×”" ××• "×¤×§×•×“×ª ×ž×¡ ×”×›× ×¡×”" ×‘×›×•×ª×¨×ª = "×¤×˜×•×¨ ×ž×ž×¡"
  â€¢ ×× ×™×© "××™×‘×”" ×‘×›×•×ª×¨×ª = "××™×‘×”"
  â€¢ ×× ×™×© "×ª××¨×™×š ×¤×’×™×¢×”" + "×ž×¢×‘×•×“×”" = "× ×›×•×ª ×ž×¢×‘×•×“×”"
  â€¢ ×× ××™×Ÿ ×ª××¨×™×š ×¤×’×™×¢×” = "× ×›×•×ª ×›×œ×œ×™×ª"
- **×¡× ×™×£ ×”×•×•×¢×“×”**: ×›×ž×• "×¡× ×™×£ ×¨××©×™ ×¨×ž×ª ×’×Ÿ", "×¡× ×™×£ ×¨××©×™ × ×ª× ×™×”"

**6. ×˜×‘×œ×ª ×”×—×œ×˜×•×ª - **×§×¨×™×˜×™! ×—×•×‘×” ×œ×—×œ×¥ ××ª ×›×œ ×”×©×•×¨×•×ª!**

**ðŸ”´ðŸ”´ðŸ”´ ×—×•×‘×” ×ž×•×—×œ×˜×ª! ðŸ”´ðŸ”´ðŸ”´**

**×ž×¦× ××ª ×”×˜×‘×œ×” "×§×‘×™×¢×ª ××—×•×–×™× ×¨×¤×•××™×™×" - ×”×™× ×ž×›×™×œ×” ×‘×“×¨×š ×›×œ×œ 10-15 ×©×•×¨×•×ª!**

**×“×•×’×ž×” ×œ×ž×¡×ž×š ×˜×™×¤×•×¡×™ - 14 ×”×—×œ×˜×•×ª (×œ× 3, ×œ× 5, ××œ× 14!):**

1. ×ª×¡×ž×•× ×ª ×”×ª×¢×œ×” ×”×§×¨×¤×œ×™×ª ×“×• ×¦×“×“×™ | 31(4)(×) | 10% | ×–×ž× ×™ | 21/08/2018 â†’ 31/12/2020
2. ×›××‘ ×‘×ž×¤×¨×§ ×”×›×ª×£ ×™×ž×™×Ÿ | 42(1)(×“)(I) | 5% | ×¦×ž×™×ª | 25/05/2020 â†’ ×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”
3. ×ª×¡×ž×•× ×ª ×”×ª×¢×œ×” ×”×§×¨×¤×œ×™×ª ×©×ž××œ | 31(4)(×) | 5% | ×¦×ž×™×ª | 01/01/2021 â†’ ×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”
4. ×ª×¡×ž×•× ×ª ×”×ª×¢×œ×” ×”×§×¨×¤×œ×™×ª ×™×ž×™×Ÿ | 31(4)(×) | 10% | ×¦×ž×™×ª | 21/01/2021 â†’ ×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”
5. ××•×‘×“×Ÿ ×©×™× ×™×™× | 74(1)(×“)(II) | 7.75% | ×¦×ž×™×ª | 01/01/2023 â†’ ×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”
6. ×“×•× × ×©×™×ž×” ×‘×©×™× ×” | 3(×’) | 20% | ×¦×ž×™×ª | 17/08/2023 â†’ ×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”
7. Trigeminal neuralgia ×©×ž××œ | 29(5)(×)(II) | 30% | ×¦×ž×™×ª | 01/05/2024 â†’ ×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”
8. ×ª×’×•×‘×” ×œ×“×—×§ ×—×ž×•×¨ | 34(×‘)(3) | 20% | ×–×ž× ×™ | 26/06/2024 â†’ 31/07/2024
9. ×ª×’×•×‘×” ×œ×“×—×§ ×—×ž×•×¨ | 34(×‘)(3) | 20% | ×¦×ž×™×ª | 01/08/2024 â†’ ×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”
10. ×ž×—×œ×ª ×œ×‘ ××™×¡×›×ž×™×ª | 9(1)(×‘)(I) | 20% | ×¦×ž×™×ª | 01/08/2024 â†’ ×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”
11. ×ª×›×™×¤×•×ª ×ž×ª×Ÿ ×©×ª×Ÿ | 23(2)(×)(II) | 10% | ×¦×ž×™×ª | 01/09/2024 â†’ ×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”
12. Disturbance of salivary secretion | 73(3)(II) | 30% | ×¦×ž×™×ª | 01/01/2025 â†’ ×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”
13. ×ž×¨×¤×§ ×˜× ×™×¡ | ××™×Ÿ × ×›×•×ª | 0% | - | 27/01/2025 â†’ -
14. ×›××‘ ×‘×¦×•×•××¨ | 37(5)(×) | 5% | ×¦×ž×™×ª | 26/03/2025 â†’ ×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”

**××ª ×›×œ 14 ×”×”×—×œ×˜×•×ª ×”××œ×” ××ª×” ×—×™×™×‘ ×œ×—×œ×¥! ×œ× ×¨×§ 5 ×ž×ª×•×›×Ÿ!**

**âš ï¸ ×›×œ×œ ×–×”×‘: ×›×œ ×©×•×¨×” ×‘×˜×‘×œ×” "×§×‘×™×¢×ª ××—×•×–×™× ×¨×¤×•××™×™×" = ×”×—×œ×˜×” ××—×ª ×‘×ž×¢×¨×š!**

**âš ï¸ ×”×‘× ×ª ×ž×‘× ×” ×”×˜×‘×œ×”:**

×”×˜×‘×œ×” × ×¨××™×ª ×›×š:
[×§×‘×™×¢×ª ××—×•×–×™× ×¨×¤×•××™×™×]

×ª×§×•×¤×”: ×ž: 21/08/2018 ×¢×“: 31/12/2020 | ××‘×—× ×”: ×ª×¡×ž×•× ×ª ×§×¨×¤×œ×™×ª ×“×• ×¦×“×“×™ | ×¡×¢×™×£: 31(4)(×) | ××—×•×–: 10% 10% | ×”×¢×¨×•×ª: ×–×ž× ×™
×ª×§×•×¤×”: ×ž: 25/05/2020 | ××‘×—× ×”: ×›××‘ ×‘×ž×¤×¨×§ ×”×›×ª×£ ×™×ž×™×Ÿ | ×¡×¢×™×£: 42(1)(×“)(I) | ××—×•×–: 5% 5% | ×”×¢×¨×•×ª: ×¦×ž×™×ª
×ª×§×•×¤×”: ×ž: 01/01/2021 | ××‘×—× ×”: ×ª×¡×ž×•× ×ª ×§×¨×¤×œ×™×ª ×©×ž××œ | ×¡×¢×™×£: 31(4)(×) | ××—×•×–: 5% 5% | ×”×¢×¨×•×ª: ×¦×ž×™×ª

**×©×™× ×œ×‘:**
- ×¢×ž×•×“×” "×ª×§×•×¤×”" ×™×›×•×œ×” ×œ×”×›×™×œ:
  â€¢ "×ž: DD/MM/YYYY ×¢×“: DD/MM/YYYY" â†’ ×™×© ×ª××¨×™×š ×”×ª×—×œ×” ×•×¡×™×•×
  â€¢ "×ž: DD/MM/YYYY" â†’ ×™×© ×¨×§ ×ª××¨×™×š ×”×ª×—×œ×” (×¡×™×•× = "×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”")
- ×¢×ž×•×“×” "×¡×¢×™×£ ×œ×™×§×•×™" ×ž×›×™×œ×” ×§×•×“ ×ž×œ× ×›×ž×•: "31(4)(×)", "42(1)(×“)(I)", "(II)(3)73"
- ×¢×ž×•×“×” "××—×•×– ×”× ×›×•×ª" ×œ×¤×¢×ž×™× ×ž×•×¤×™×¢×” ×¤×¢×ž×™×™× (10% 10%) - **×§×— ××ª ×”×ž×¡×¤×¨ ×”×¨××©×•×Ÿ**
- ×¢×ž×•×“×” "×”×¢×¨×•×ª" ×ž×›×™×œ×” "×–×ž× ×™" ××• "×¦×ž×™×ª" - ×–×• "×ž×™×“×ª ×”× ×›×•×ª"

**âš ï¸ ×§×¨×™×˜×™ ×ž××•×“! ×”×‘× ×ª ×”×¢×ž×•×“×•×ª - ×‘×“×•×§ 3 ×¤×¢×ž×™×!**

**ðŸ”´ ×›×œ×œ ×ž×¡×¤×¨ 1 - ×—×¤×© ××ª ×”×˜×‘×œ×” ×”× ×›×•× ×”!**
- ×”×˜×‘×œ×” × ×§×¨××ª **"×§×‘×™×¢×ª ××—×•×–×™× ×¨×¤×•××™×™×"** - ×—×¤×© ×‘×“×™×•×§ ××ª ×”×›×•×ª×¨×ª ×”×–×•!
- ××œ ×ª×ª×‘×œ×‘×œ ×¢× ×˜×‘×œ××•×ª ××—×¨×•×ª ×‘×ž×¡×ž×š ×©×ž×›×™×œ×•×ª ×—×•×•×ª ×“×¢×ª ×‘×•×“×“×•×ª
- ×–×• ×”×˜×‘×œ×” ×”×ž×¨×›×–×ª ×•×”×¡×•×¤×™×ª ×©×ž×›×™×œ×” ××ª ×›×œ ×”×”×—×œ×˜×•×ª ×‘×ž×§×•× ××—×“

**ðŸ”´ ×›×œ×œ ×ž×¡×¤×¨ 2 - ×ª××¨×™×›×™× ×©×•× ×™× ×œ×›×œ ×©×•×¨×”!**
- **×›×œ ×©×•×¨×” ×‘×˜×‘×œ×” ×™×›×•×œ×” ×œ×”×™×•×ª ×ž×ª×§×•×¤×” ××—×¨×ª ×œ×—×œ×•×˜×™×Ÿ!**
- ×“×•×’×ž××•×ª:
  â€¢ ×©×•×¨×” 1: ×ž: 21/08/2018 ×¢×“: 31/12/2020
  â€¢ ×©×•×¨×” 2: ×ž: 25/05/2020
  â€¢ ×©×•×¨×” 3: ×ž: 01/01/2021
  â€¢ ×©×•×¨×” 4: ×ž: 21/01/2021
- **××œ ×ª× ×™×— ×©×›×œ ×”×©×•×¨×•×ª ×ž××•×ª×” ×ª×§×•×¤×”!**

**ðŸ”´ ×›×œ×œ ×ž×¡×¤×¨ 3 - ××—×•×– ×”× ×›×•×ª ×”×•× ×ª×ž×™×“ ×ž×¡×¤×¨!**
- ×”×©×“×” "××—×•×– ×”× ×›×•×ª" **×—×™×™×‘** ×œ×”×›×™×œ ×ž×¡×¤×¨: 5%, 10%, 15%, 20%, 25%, 30%, ×•×›×•'
- **×–×” ××£ ×¤×¢× ×œ× ×™×›×•×œ ×œ×”×™×•×ª** "×–×ž× ×™" ××• "×¦×ž×™×ª" ××• "×§×‘×•×¢"!
- ×× ××ª×” ×¨×•××” "×–×ž× ×™" ××• "×¦×ž×™×ª" - ×–×” **×œ×** ××—×•×– ×”× ×›×•×ª! ×–×” "×ž×™×“×ª ×”× ×›×•×ª"!

**××™×š ×œ×§×¨×•× ×›×œ ×©×•×¨×” ×‘×˜×‘×œ×” "×§×‘×™×¢×ª ××—×•×–×™× ×¨×¤×•××™×™×":**

×“×•×’×ž×” ×œ×©×•×¨×” ×ž×”×˜×‘×œ×”:
[×ž: 21/08/2018 ×¢×“: 31/12/2020 | ×ª×¡×ž×•× ×ª ×”×ª×¢×œ×” ×”×§×¨×¤×œ×™×ª ×“×• ×¦×“×“×™ | 31(4)(×) ×¤×’×™×¢×” ×‘×¢×¦×‘... | 10% 10% | ×–×ž× ×™ - ×¡×¢×™×£ ×ž×•×ª××]

×—×™×œ×•×¥ × ×›×•×Ÿ:
1. **×ª×§×•×¤×”**: "×ž: 21/08/2018 ×¢×“: 31/12/2020"
   - "×ž×ª××¨×™×š": "21/08/2018"
   - "×¢×“ ×ª××¨×™×š": "31/12/2020"

2. **××‘×—× ×”**: "×ª×¡×ž×•× ×ª ×”×ª×¢×œ×” ×”×§×¨×¤×œ×™×ª ×“×• ×¦×“×“×™"

3. **×¡×¢×™×£ ×œ×™×§×•×™**: "31(4)(×)" â† ×§×— ×¨×§ ××ª ×”×§×•×“, ×œ× ××ª ×”×ª×™××•×¨ ×”×ž×œ×!
   - ×“×•×’×ž××•×ª ×§×•×“×™×: "31(4)(×)", "42(1)(×“)(I)", "(II)(3)73", "23(2)(×)(II)"

4. **××—×•×– ×”× ×›×•×ª**: "10%" â† ×œ×¤×¢×ž×™× ×›×ª×•×‘ "10% 10%" - ×§×— ××ª ×”×ž×¡×¤×¨ ×”×¨××©×•×Ÿ!

5. **×ž×™×“×ª ×”× ×›×•×ª**: "×–×ž× ×™" â† ×–×” ×ž×•×¤×™×¢ ×‘×¢×ž×•×“×ª "×”×¢×¨×•×ª"

**××™×š ×œ×—×œ×¥ ×ž×›×œ ×©×•×¨×”:**
1. **×ª×§×•×¤×”** (×¢×ž×•×“×” 1) â†’ "×ž×ª××¨×™×š" + "×¢×“ ×ª××¨×™×š"
2. **××‘×—× ×”** (×¢×ž×•×“×” 2) â†’ "××‘×—× ×”"
3. **×¡×¢×™×£** (×¢×ž×•×“×” 3) â†’ "×¡×¢×™×£ ×œ×™×§×•×™" (×›×ž×• "×ž×•×ª××", "×¢×“", "(II)(23)2()×")
4. **××—×•×–** (×¢×ž×•×“×” 4) â†’ "××—×•×– ×”× ×›×•×ª" (**×—×™×™×‘ ×œ×”×™×•×ª ×ž×¡×¤×¨!** 20%, 15%, ×•×›×•')
5. **×”×¢×¨×•×ª** (×¢×ž×•×“×” 5) â†’ "×ž×™×“×ª ×”× ×›×•×ª" (×–×ž× ×™/×¦×ž×™×ª)

**ðŸ”´ ×©×’×™××•×ª × ×¤×•×¦×•×ª - ××œ ×ª×¢×©×” ××ª ×–×”:**
âŒ "××—×•×– ×”× ×›×•×ª": "×–×ž× ×™" â† **×©×’×•×™!** ×–×” ×¦×¨×™×š ×œ×”×™×•×ª ×ž×¡×¤×¨!
âŒ "××—×•×– ×”× ×›×•×ª": "×¦×ž×™×ª" â† **×©×’×•×™!** ×–×” ×¦×¨×™×š ×œ×”×™×•×ª ×ž×¡×¤×¨!
âŒ "××—×•×– ×”× ×›×•×ª": "×ž×•×ª××" â† **×©×’×•×™!** ×–×” ×¡×¢×™×£ ×œ×™×§×•×™, ×œ× ××—×•×–!

âœ… "××—×•×– ×”× ×›×•×ª": "20%" â† × ×›×•×Ÿ!
âœ… "×ž×™×“×ª ×”× ×›×•×ª": "×¦×ž×™×ª" â† × ×›×•×Ÿ!


**ðŸ“‹ ×“×•×’×ž×” - ××™×š ×œ×§×¨×•× ×©×•×¨×”:**

×©×•×¨×” ×‘×˜×‘×œ×”:
[×ž: 01/09/2024 | ×ª×›×™×¤×•×ª ×ž×ª×Ÿ ×©×ª×Ÿ | (II)(23)2()× | 10% | ×¦×ž×™×ª]

×—×™×œ×•×¥ × ×›×•×Ÿ:
- ×¢×ž×•×“×” 1: "×ž: 01/09/2024" â†’ "×ž×ª××¨×™×š": "01/09/2024", "×¢×“ ×ª××¨×™×š": "×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”"
- ×¢×ž×•×“×” 2: "×ª×›×™×¤×•×ª ×ž×ª×Ÿ ×©×ª×Ÿ" â†’ "××‘×—× ×”": "×ª×›×™×¤×•×ª ×ž×ª×Ÿ ×©×ª×Ÿ"
- ×¢×ž×•×“×” 3: "(II)(23)2()×" â†’ "×¡×¢×™×£ ×œ×™×§×•×™": "(II)(23)2()×"
- ×¢×ž×•×“×” 4: "10%" â†’ **"××—×•×– ×”× ×›×•×ª": "10%"** â† ×–×” ×ž×¡×¤×¨!
- ×¢×ž×•×“×” 5: "×¦×ž×™×ª" â†’ **"×ž×™×“×ª ×”× ×›×•×ª": "×¦×ž×™×ª"** â† ×–×” ×œ× ×ž×¡×¤×¨!

â†’ JSON ×ª×•×¦××”:
[
  {
    "××‘×—× ×”": "×ª×›×™×¤×•×ª ×‘×ž×ª×Ÿ ×©×ª×Ÿ",
    "×¡×¢×™×£ ×œ×™×§×•×™": "(II)(23)2()×",
    "××—×•×– ×”× ×›×•×ª": "10%",
    "×ž×ª××¨×™×š": "01/09/2024",
    "×¢×“ ×ª××¨×™×š": "×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”",
    "×ž×™×“×ª ×”× ×›×•×ª": "×¦×ž×™×ª",
    "×”×¢×¨×•×ª": null
  },
  {
    "××‘×—× ×”": "×›××‘ ×‘×ž×¤×¨×§",
    "×¡×¢×™×£ ×œ×™×§×•×™": "×¢×“",
    "××—×•×– ×”× ×›×•×ª": "20%",
    "×ž×ª××¨×™×š": "01/01/2025",
    "×¢×“ ×ª××¨×™×š": "31/12/2025",
    "×ž×™×“×ª ×”× ×›×•×ª": "×–×ž× ×™",
    "×”×¢×¨×•×ª": null
  }
]

×©×•×¨×” × ×•×¡×¤×ª:
| ×ž: 01/01/2025 ×¢×“: 31/12/2025 | ×›××‘ ×‘×ž×¤×¨×§ | ×¢×“ | 20% | ×–×ž× ×™ |

â†’ ×ª×”×™×”:
  {
    "××‘×—× ×”": "×›××‘ ×‘×ž×¤×¨×§",
    "×¡×¢×™×£ ×œ×™×§×•×™": "×¢×“",
    "××—×•×– ×”× ×›×•×ª": "20%",
    "×ž×ª××¨×™×š": "01/01/2025",
    "×¢×“ ×ª××¨×™×š": "31/12/2025",
    "×ž×™×“×ª ×”× ×›×•×ª": "×–×ž× ×™",
    "×”×¢×¨×•×ª": null
  }
]

**âš ï¸ ×§×¨×™×˜×™! ×–×›×•×¨:**
- **×—×œ×¥ ×›×œ ×”×©×•×¨×•×ª!** ×œ× ×¨×§ 2-3! ×× ×™×© 14 ×©×•×¨×•×ª â†’ ×”×—×–×¨ 14 ×”×—×œ×˜×•×ª!
- **××—×•×– ×”× ×›×•×ª** = ×ž×¡×¤×¨ ×‘×œ×‘×“ (5%, 10%, 20%, 30%)
- **×ž×™×“×ª ×”× ×›×•×ª** = ×–×ž× ×™/×¦×ž×™×ª ×‘×œ×‘×“
- **×¡×¢×™×£ ×œ×™×§×•×™** = ×”×§×•×“ ×”×ž×œ× ×ž×”×˜×‘×œ×”
- **×ª××¨×™×›×™×** = ×›×œ ×©×•×¨×” ×™×›×•×œ×” ×œ×”×™×•×ª ×ž×ª××¨×™×š ××—×¨!
- ×× ×”×˜×‘×œ×” ××¨×•×›×” â†’ **×”×ž×©×š ×¢×“ ×”×¡×•×£, ××œ ×ª×§×¦×¨!**
  
- **××—×•×– ×”× ×›×•×ª ×ž×©×•×§×œ×œ**: ×”×©×§×œ×•×œ ×œ×—×™×©×•×‘ ×¤×˜×•×¨ ×ž×ž×¡
  â€¢ **×§×¨×™×˜×™! ×¡×“×¨ ×—×™×¤×•×© (×—×•×‘×” ×œ×¢×§×•×‘ ××—×¨×™ ×”×¡×“×¨!):**
    1. **×ž×©×¤×˜ ×¡×™×›×•× ×¡×•×¤×™ - ×–×• ×”×¢×“×™×¤×•×ª ×”×ž×•×—×œ×˜×ª ×”×’×‘×•×”×” ×‘×™×•×ª×¨!**
       - **×ª×ž×™×“** ×—×¤×© ×‘×ž×¡×ž×š ×ž×©×¤×˜ ×©×ž×›×™×œ ××ª ×”×ž×™×œ×™×:
         â€¢ "× ×§×‘×¢×” ×œ×š × ×›×•×ª ×§×‘×•×¢×” ×©×œ"
         â€¢ "× ×§×‘×¢×” ×œ×š × ×›×•×ª ×–×ž× ×™×ª ×©×œ"
         â€¢ "× ×§×‘×¢×” ×œ×š × ×›×•×ª ×©×œ"
         â€¢ "×•××™×œ×š × ×§×‘×¢×” ×œ×š × ×›×•×ª"
       - ×“×•×’×ž××•×ª:
         â€¢ "×ž- 26/03/2025 ×•××™×œ×š × ×§×‘×¢×” ×œ×š × ×›×•×ª ×§×‘×•×¢×” ×©×œ 84.08%" â†’ **84.08%**
         â€¢ "× ×§×‘×¢×” ×œ×š × ×›×•×ª ×¦×ž×™×ª×” ×©×œ 75.5%" â†’ **75.5%**
       - **×× ×ž×¦××ª ×ž×©×¤×˜ ×›×–×” - ×”×©×ª×ž×© ×¨×§ ×‘×•! ×”×ª×¢×œ× ×ž×›×œ ×˜×‘×œ×” ××—×¨×ª!**
       - **×–×”×• ×”××—×•×– ×”×ž×©×•×§×œ×œ ×”××ž×™×ª×™ ×•×”×¡×•×¤×™ ×•×”×ž×“×•×™×§ ×‘×™×•×ª×¨ ×‘×ž×¡×ž×š!**
    
    2. **×˜×‘×œ×” ×¢× "×©×§×œ×•×œ × ×›×•×ª"** - ×× ×§×™×™×ž×ª ×˜×‘×œ×” ×¡×•×¤×™×ª ×¢× ×¢×ž×•×“×” ×–×•:
       | × ×›×•×ª | ×©×§×œ×•×œ × ×›×•×ª | × ×›×•×ª ×ž×©×•×§×œ×œ |
       | 30.7% | 31% | ×–×ž× ×™ |
       â†’ ×”×—×–×¨: "31%"
    
    3. **××—×¨×ª** - ×”×—×–×¨ ××ª ××•×ª×• ×¢×¨×š ×›×ž×• "××—×•×– ×”× ×›×•×ª" (×× ××™×Ÿ ×¢×ž×•×“×” × ×¤×¨×“×ª)
  
  â€¢ **×œ× ×ª×ž×™×“ ×™×© ×©×“×” × ×¤×¨×“**, ×‘×ž×§×¨×™× ×¨×‘×™× ×–×” ×–×”×” ×œ"××—×•×– ×”× ×›×•×ª"
  
- **×ž×ª××¨×™×š ×•×¢×“ ×ª××¨×™×š - ×§×¨×™×˜×™!**
  â€¢ **×¡×“×¨ ×—×™×¤×•×© (×‘×¢×“×™×¤×•×ª ×’×‘×•×”×” ×ž××•×“!):**
    1. **×ž×©×¤×˜ ×¡×™×›×•× ×¡×•×¤×™** - **×–×• ×”×¢×“×™×¤×•×ª ×”×’×‘×•×”×” ×‘×™×•×ª×¨!**:
       - ×—×¤×© ×‘×ž×¡×ž×š ×ž×©×¤×˜ ×›×ž×•:
         â€¢ "×ž-XX/XX/XXXX ×•××™×œ×š × ×§×‘×¢×” ×œ×š × ×›×•×ª ×§×‘×•×¢×” ×©×œ X%"
         â€¢ "×ž-XX/XX/XXXX ×¢×“ XX/XX/XXXX × ×§×‘×¢×” ×œ×š × ×›×•×ª ×©×œ X%"
         â€¢ "×ž-XX/XX/XXXX × ×§×‘×¢×” ×œ×š × ×›×•×ª ×©×œ X%"
       - ×“×•×’×ž×”: "×ž- 26/03/2025 ×•××™×œ×š × ×§×‘×¢×” ×œ×š × ×›×•×ª ×§×‘×•×¢×” ×©×œ 84.08%"
       - **×ž×ª××¨×™×š**: "26/03/2025"
       - **×¢×“ ×ª××¨×™×š**: "×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”" (×× ×›×ª×•×‘ "×•××™×œ×š" ××• "×§×‘×•×¢×”")
       - **×¢×“ ×ª××¨×™×š**: ×”×ª××¨×™×š ×”×¡×¤×¦×™×¤×™ (×× ×™×© ×ª××¨×™×š ×¡×™×•× ×ž×¤×•×¨×©)
    
    2. **×˜×‘×œ×ª "×”×—×œ×˜×” ××—×¨×•× ×” ×ž×ª××¨×™×š" ××• "×”×—×œ×˜×” ×¨×¤×•××™×ª ×ž×ª××¨×™×š"**:
       - ×“×•×’×ž×”:
         | ×¢×“ ×ª××¨×™×š | ×ž×ª××¨×™×š | × ×›×•×ª ×¨×¤×•××™×ª |
         | 31/10/2025 | 16/02/2025 | 21.0% |
       - **×ž×ª××¨×™×š**: "16/02/2025"
       - **×¢×“ ×ª××¨×™×š**: "31/10/2025"
    
    3. **×˜×‘×œ×” ×¡×•×¤×™×ª** ×¢× "×ž×ª××¨×™×š" ×•"×ª××¨×™×š ×¢×“":
       | × ×›×•×ª | ×©×§×œ×•×œ × ×›×•×ª | × ×›×•×ª ×ž×©×•×§×œ×œ | ×ª××¨×™×š ×¢×“ | ×ž×ª××¨×™×š |
       | 30.7% | 31% | ×–×ž× ×™ | 31/10/2026 | 01/11/2025 |
       â†’ ×ž×ª××¨×™×š: "01/11/2025", ×¢×“ ×ª××¨×™×š: "31/10/2026"
    
    4. **×˜×‘×œ×” ×¢× "×”×ª×§×•×¤×”"** - ×§×— ××ª ×”×©×•×¨×” **×”××—×¨×•× ×”**:
       | ×”×ª×§×•×¤×” | ×”× ×›×•×ª ×”×¨×¤×•××™×ª |
       | ×ž-01/04/2024 ×•××™×œ×š | 28.0% |
       â†’ ×ž×ª××¨×™×š: "01/04/2024"
       â†’ ×¢×“ ×ª××¨×™×š: "×¢×“ ×œ×”×•×“×¢×” ×—×“×©×”" (×× ×›×ª×•×‘ "×•××™×œ×š")
  

**×¤×•×¨×ž×˜ ×”×—×–×¨×” - JSON ×‘×œ×‘×“:**
{
  "×›×•×ª×¨×ª ×”×•×¢×“×”": "...",
  "×¡×•×’ ×•×¢×“×”": "...",
  "×©× ×˜×•×¤×¡": "...",
  "×¡× ×™×£ ×”×•×•×¢×“×”": "...",
  "×©× ×”×ž×‘×•×˜×—": "...",
  "×ª.×–:": "...",
  "×ª××¨×™×š ×•×¢×“×”": "...",
  "×ª××¨×™×š ×¤×’×™×¢×”(×¨×§ ×‘××™×‘×”,× ×›×•×ª ×ž×¢×‘×•×“×”)": "...",
  "×ž×©×ª×ª×£ ×•×¢×“×” 1": "...",
  "×ž×©×ª×ª×£ ×•×¢×“×” 2": "...",
  "×ž×©×ª×ª×£ ×•×¢×“×” 3": "...",
  "×ž×©×ª×ª×£ ×•×¢×“×” 4": "...",
  "×”×—×œ×˜×•×ª": [
    {
      "××‘×—× ×”": "...",
      "×¡×¢×™×£ ×œ×™×§×•×™": "...",
      "××—×•×– ×”× ×›×•×ª": "...",
      "×ž×ª××¨×™×š": "...",
      "×¢×“ ×ª××¨×™×š": "...",
      "×ž×™×“×ª ×”× ×›×•×ª": "...",
      "×”×¢×¨×•×ª": "..."
    }
  ],
  "××—×•×– ×”× ×›×•×ª ×”× ×•×‘×¢ ×ž×”×¤×’×™×¢×”": "...",
  "××—×•×– ×”× ×›×•×ª ×ž×©×•×§×œ×œ": "...",
  "×©×§×œ×•×œ ×œ×¤×˜×•×¨ ×ž×ž×¡": "..."
}

**×—×•×‘×”: ×¨×§ JSON, ×œ×œ× ×”×¡×‘×¨×™× ××• ×˜×§×¡×˜ × ×•×¡×£!**`;
}

function parseOpenAIResponse(content: string): any {
  console.log('OpenAI raw response content:', content);
  
  try {
    // Clean the response
    let cleanContent = content.trim();
    
    // Remove markdown code blocks
    if (cleanContent.startsWith('```json')) {
      cleanContent = cleanContent.replace(/^```json\s*/, '').replace(/\s*```$/, '');
    } else if (cleanContent.startsWith('```')) {
      cleanContent = cleanContent.replace(/^```\s*/, '').replace(/\s*```$/, '');
    }
    
    // Apply multiple rounds of JSON fixing
    cleanContent = fixJsonFormatting(cleanContent);
    
    let extractedData;
    try {
      extractedData = JSON.parse(cleanContent);
    } catch (parseError) {
      console.error('First parse attempt failed:', parseError);
      
      // Try more aggressive fixing
      let fixedContent = cleanContent
        .replace(/\u200B/g, '') // Zero-width space
        .replace(/\u00A0/g, ' ') // Non-breaking space
        .replace(/[\u200C\u200D]/g, '') // Zero-width non-joiner/joiner
        .replace(/[\u202A-\u202E]/g, '') // Left-to-right/right-to-left marks
        .replace(/\\/g, '\\\\') // Escape backslashes
        .replace(/"/g, '\\"') // Escape quotes
        .replace(/\\"/g, '"') // Fix over-escaped quotes
        .replace(/"\s*:\s*"/g, '": "') // Fix spacing around colons
        .replace(/",\s*"/g, '", "') // Fix spacing around commas
        .trim();
      
      // Try to fix common JSON issues
      fixedContent = fixJsonFormatting(fixedContent);
      
      try {
        extractedData = JSON.parse(fixedContent);
      } catch (secondParseError) {
        console.error('Second parse attempt failed:', secondParseError);
        
        // Last resort: use regex to extract fields
        return extractDataWithRegex(content);
      }
    }
    
    const convertToString = (value: any): string => {
      if (value === null || value === undefined || value === "null") return "";
      if (typeof value === 'string') return value;
      if (Array.isArray(value)) {
        return value.map(item => {
          if (typeof item === 'object' && item !== null) {
            if (item.×©× && item.×ª×¤×§×™×“) {
              return `${item.×©×} (${item.×ª×¤×§×™×“})`;
            }
            return Object.values(item).join(' - ');
          }
          return String(item);
        }).join(', ');
      }
      if (typeof value === 'object' && value !== null) return JSON.stringify(value);
      return String(value);
    };
    
    const result: any = {};
    
    const fieldMapping = {
      "×›×•×ª×¨×ª ×”×•×¢×“×”": "×›×•×ª×¨×ª ×”×•×¢×“×”",
      "×¡×•×’ ×•×¢×“×”": "×¡×•×’ ×•×¢×“×”",
      "×©× ×˜×•×¤×¡": "×©× ×˜×•×¤×¡", 
      "×¡× ×™×£ ×”×•×•×¢×“×”": "×¡× ×™×£ ×”×•×•×¢×“×”",
      "×©× ×”×ž×‘×•×˜×—": "×©× ×”×ž×‘×•×˜×—",
      "×ª.×–:": "×ª.×–:",
      "×ª××¨×™×š ×•×¢×“×”": "×ª××¨×™×š ×•×¢×“×”",
      "×ª××¨×™×š ×¤×’×™×¢×”(×¨×§ ×‘××™×‘×”,× ×›×•×ª ×ž×¢×‘×•×“×”)": "×ª××¨×™×š ×¤×’×™×¢×”(×¨×§ ×‘××™×‘×”,× ×›×•×ª ×ž×¢×‘×•×“×”)",
      "×ž×©×ª×ª×£ ×•×¢×“×” 1": "×ž×©×ª×ª×£ ×•×¢×“×” 1",
      "×ž×©×ª×ª×£ ×•×¢×“×” 2": "×ž×©×ª×ª×£ ×•×¢×“×” 2",
      "×ž×©×ª×ª×£ ×•×¢×“×” 3": "×ž×©×ª×ª×£ ×•×¢×“×” 3",
      "×ž×©×ª×ª×£ ×•×¢×“×” 4": "×ž×©×ª×ª×£ ×•×¢×“×” 4",
      "×ž×©×ª×ª×¤×™ ×”×•×¢×“×”": "×ž×©×ª×ª×¤×™ ×”×•×¢×“×”",
      "××‘×—× ×”": "××‘×—× ×”",
      "×¡×¢×™×£ ×œ×™×§×•×™": "×¡×¢×™×£ ×œ×™×§×•×™",
      "××—×•×– ×”× ×›×•×ª": "××—×•×– ×”× ×›×•×ª",
      "××—×•×– ×”× ×›×•×ª ×”× ×•×‘×¢ ×ž×”×¤×’×™×¢×”": "××—×•×– ×”× ×›×•×ª ×”× ×•×‘×¢ ×ž×”×¤×’×™×¢×”",
      "×”×¢×¨×•×ª": "×”×¢×¨×•×ª",
      "×ž×ª××¨×™×š": "×ž×ª××¨×™×š",
      "×¢×“ ×ª××¨×™×š": "×¢×“ ×ª××¨×™×š", 
      "×ž×™×“×ª ×”× ×›×•×ª": "×ž×™×“×ª ×”× ×›×•×ª",
      "××—×•×– ×”× ×›×•×ª ×ž×©×•×§×œ×œ": "××—×•×– ×”× ×›×•×ª ×ž×©×•×§×œ×œ",
      "×©×§×œ×•×œ ×œ×¤×˜×•×¨ ×ž×ž×¡": "×©×§×œ×•×œ ×œ×¤×˜×•×¨ ×ž×ž×¡"
    };
    
    Object.entries(fieldMapping).forEach(([key, field]) => {
      if (extractedData.hasOwnProperty(key)) {
        const value = convertToString(extractedData[key]);
        result[field] = value;
      }
    });
    
    // Handle "×”×—×œ×˜×•×ª" separately - keep it as an array
    if (extractedData.hasOwnProperty("×”×—×œ×˜×•×ª") && Array.isArray(extractedData["×”×—×œ×˜×•×ª"])) {
      result["×”×—×œ×˜×•×ª"] = extractedData["×”×—×œ×˜×•×ª"];
    }
    
    return result;
    
  } catch (parseError) {
    console.error('JSON parse error:', parseError);
    return {};
  }
}

function fixJsonFormatting(content: string): string {
  let fixed = content.trim();
  
  // Extract JSON object
  const jsonStart = fixed.indexOf('{');
  const jsonEnd = fixed.lastIndexOf('}') + 1;
  if (jsonStart !== -1 && jsonEnd !== -1) {
    fixed = fixed.substring(jsonStart, jsonEnd);
  }
  
  // Fix common JSON formatting issues
  fixed = fixed.replace(/}\s*\n?\s*{/g, '},\n    {');
  fixed = fixed.replace(/"\s*\n\s*"/g, '",\n  "');
  fixed = fixed.replace(/"\s*\n\s*}/g, '"\n  }');
  fixed = fixed.replace(/]\s*\n\s*"/g, '],\n  "');
  
  // Handle null values
  fixed = fixed.replace(/"null"/g, 'null');
  fixed = fixed.replace(/:\s*null\s*"/g, ': null');
  fixed = fixed.replace(/:\s*""\s*,/g, ': null,');
  fixed = fixed.replace(/:\s*""\s*}/g, ': null}');
  
  // Remove trailing commas
  fixed = fixed.replace(/,(\s*[}\]])/g, '$1');
  
  // Fix unquoted property names
  fixed = fixed.replace(/(\n\s*)([^"{\s][^:\n]*?)(\s*:)/g, '$1"$2"$3');
  
  // Fix escaped quotes in values
  fixed = fixed.replace(/: "([^"]*)\\"([^"]*)"([^,}\n]*)/g, ': "$1\\"$2"');
  
  // Ensure proper structure
  if (!fixed.startsWith('{')) fixed = '{' + fixed;
  if (!fixed.endsWith('}')) fixed = fixed + '}';
  
  return fixed;
}

function extractDataWithRegex(content: string): any {
  console.log('Using regex fallback for data extraction');
  
  const result: any = {};
  
  const patterns = {
    '×›×•×ª×¨×ª ×”×•×¢×“×”': /"×›×•×ª×¨×ª ×”×•×¢×“×”"[:\s]*"([^"]+)"/,
    '×¡×•×’ ×•×¢×“×”': /"×¡×•×’ ×•×¢×“×”"[:\s]*"([^"]+)"/,
    '×©× ×˜×•×¤×¡': /"×©× ×˜×•×¤×¡"[:\s]*"([^"]+)"/,
    '×¡× ×™×£ ×”×•×•×¢×“×”': /"×¡× ×™×£ ×”×•×•×¢×“×”"[:\s]*"([^"]+)"/,
    '×©× ×”×ž×‘×•×˜×—': /"×©× ×”×ž×‘×•×˜×—"[:\s]*"([^"]+)"/,
    '×ª.×–:': /"×ª\.×–:"[:\s]*"([^"]+)"/,
    '×ª××¨×™×š ×•×¢×“×”': /"×ª××¨×™×š ×•×¢×“×”"[:\s]*"([^"]+)"/,
    '×ª××¨×™×š ×¤×’×™×¢×”(×¨×§ ×‘××™×‘×”,× ×›×•×ª ×ž×¢×‘×•×“×”)': /"×ª××¨×™×š ×¤×’×™×¢×”\(×¨×§ ×‘××™×‘×”,× ×›×•×ª ×ž×¢×‘×•×“×”\)"[:\s]*"([^"]+)"/,
    '×ž×©×ª×ª×¤×™ ×”×•×¢×“×”': /"×ž×©×ª×ª×¤×™ ×”×•×¢×“×”"[:\s]*"([^"]+)"/,
    '××‘×—× ×”': /"××‘×—× ×”"[:\s]*"([^"]+)"/,
    '×¡×¢×™×£ ×œ×™×§×•×™': /"×¡×¢×™×£ ×œ×™×§×•×™"[:\s]*"([^"]+)"/,
    '××—×•×– ×”× ×›×•×ª': /"××—×•×– ×”× ×›×•×ª"[:\s]*"([^"]+)"/,
    '××—×•×– ×”× ×›×•×ª ×”× ×•×‘×¢ ×ž×”×¤×’×™×¢×”': /"××—×•×– ×”× ×›×•×ª ×”× ×•×‘×¢ ×ž×”×¤×’×™×¢×”"[:\s]*"([^"]+)"/,
    '×”×¢×¨×•×ª': /"×”×¢×¨×•×ª"[:\s]*"([^"]+)"/,
    '×ž×ª××¨×™×š': /"×ž×ª××¨×™×š"[:\s]*"([^"]+)"/,
    '×¢×“ ×ª××¨×™×š': /"×¢×“ ×ª××¨×™×š"[:\s]*"([^"]+)"/,
    '×ž×™×“×ª ×”× ×›×•×ª': /"×ž×™×“×ª ×”× ×›×•×ª"[:\s]*"([^"]+)"/,
    '××—×•×– ×”× ×›×•×ª ×ž×©×•×§×œ×œ': /"××—×•×– ×”× ×›×•×ª ×ž×©×•×§×œ×œ"[:\s]*"([^"]+)"/,
    '×©×§×œ×•×œ ×œ×¤×˜×•×¨ ×ž×ž×¡': /"×©×§×œ×•×œ ×œ×¤×˜×•×¨ ×ž×ž×¡"[:\s]*"([^"]+)"/
  };
  
  Object.entries(patterns).forEach(([key, pattern]) => {
    const match = content.match(pattern);
    result[key] = match ? match[1] : "";
  });
  
  return result;
}

function cleanHebrewText(text: string): string {
  if (!text) return '';
  
  let cleaned = text
    // Remove Hebrew diacritics
    .replace(/[\u0591-\u05BD\u05BF-\u05C2\u05C4-\u05C5\u05C7]/g, '')
    // Replace Hebrew punctuation
    .replace(/[×ƒÖ¾]/g, ' ')
    // Clean Hebrew letters with diacritics
    .replace(/[\u05D0-\u05EA][\u0590-\u05C7]+/g, match => match.charAt(0))
    // Replace Hebrew quotes
    .replace(/[×´×³]/g, '"')
    // Clean up corrupted characters and symbols
    .replace(/[Î»âŠ¥Î±Î›Î‘Î±Î²Î³Î´ÎµÎ¶Î·Î¸Î¹ÎºÎ¼Î½Î¾Î¿Ï€ÏÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰âˆ âˆ€âˆâˆ‚âˆƒâˆ„âˆ…âˆ†âˆ‡âˆˆâˆ‰âˆŠâˆ‹âˆŒâˆâˆŽâˆâˆâˆ‘âˆ’âˆ“âˆ”âˆ•âˆ–âˆ—âˆ˜âˆ™âˆšâˆ›âˆœâˆâˆžâˆŸâˆ âˆ¡âˆ¢âˆ£âˆ¤âˆ¥âˆ¦âˆ§âˆ¨âˆ©âˆªâˆ«âˆ¬âˆ­âˆ®âˆ¯âˆ°âˆ±âˆ²âˆ³âˆ´âˆµâˆ¶âˆ·âˆ¸âˆ¹âˆºâˆ»âˆ¼âˆ½âˆ¾âˆ¿â‰€â‰â‰‚â‰ƒâ‰„â‰…â‰†â‰‡â‰ˆâ‰‰â‰Šâ‰‹â‰Œâ‰â‰Žâ‰]/g, '')
    // Remove corrupted text patterns
    .replace(/[UIXLGCETANOWK]+/g, '')
    // Clean up random symbols and punctuation
    .replace(/[^\u05D0-\u05EA\u0590-\u05FF0-9a-zA-Z\s.,;:!?()\[\]{}"'-]/g, ' ')
    // Normalize whitespace
    .replace(/\s+/g, ' ')
    .trim();
    
  // Try to reconstruct readable Hebrew text by looking for patterns
  const hebrewWords = cleaned.match(/[\u05D0-\u05EA]{2,}/g) || [];
  const englishWords = cleaned.match(/[a-zA-Z]{2,}/g) || [];
  const numbers = cleaned.match(/\d+/g) || [];
  
  // If we have some Hebrew content, keep it
  if (hebrewWords.length > 0) {
    const reconstructed = [...hebrewWords, ...englishWords, ...numbers].join(' ');
    if (reconstructed.length > cleaned.length * 0.3) {
      return reconstructed;
    }
  }
  
  return cleaned;
}

function calculateReadableRatio(text: string): number {
  if (!text || text.length === 0) return 0;
  
  const hebrewLetters = (text.match(/[\u05D0-\u05EA]/g) || []).length;
  const englishLetters = (text.match(/[a-zA-Z]/g) || []).length;
  const digits = (text.match(/\d/g) || []).length;
  const punctuation = (text.match(/[.,;:!?()[\]{}"-]/g) || []).length;
  const spaces = (text.match(/\s/g) || []).length;
  
  const readableChars = hebrewLetters + englishLetters + digits + punctuation + spaces;
  const ratio = (readableChars / text.length) * 100;
  
  const words = text.split(/\s+/).filter(word => 
    word.length > 1 && (/[\u05D0-\u05EA]/.test(word) || /[a-zA-Z]/.test(word))
  );
  const wordBonus = Math.min((words.length / 10) * 5, 15);
  
  return Math.min(ratio + wordBonus, 100);
}